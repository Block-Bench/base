{
  "id": "ss_l3_medium_sn_gs_002",
  "contract_file": "contracts/ss_l3_medium_sn_gs_002.sol",
  "subset": "shapeshifter",
  "ground_truth": {
    "is_vulnerable": true,
    "vulnerability_type": "logic_error",
    "severity": "medium",
    "vulnerable_location": {
      "contract_name": "CLFactory",
      "function_name": "_0x3ee766",
      "line_numbers": []
    },
    "root_cause": "Governance can configure `DynamicSwapFeeModule` with fees up to 50%, but `CLFactory.getSwapFee` discards any value above 100_000 ppm (10%) and falls back to the tick-spacing default (often 500 ppm = 0.05%) without reverting or logging. Operators see the module reporting 20%, yet users continue paying the tiny default fee. The silent fallback misleads governance into believing higher fees are active. Impact - Governance believes a protective high fee is set (e.g., during launch anti-MEV), but the effective fee drops back to the default (e.g., 0.05%). - Traders are charged far less than intended, defeating protective or revenue objectives. - The misconfiguration has no on-chain signal, so the mistake can persist unnoticed. Root Cause - getSwapFee checks fee <= 100_000 ; larger values are ignored and the function returns tickSpacingToFee . - The module itself allows feeCap up to 500_000 (50%), so governance can set a value the factory immediately discards in favor of the default.",
    "attack_vector": "cd cl forge test --match-path test/PoC_DynamicFee_ClampToDefault.t.sol -vvv The PoC lifts the module cap, sets a 20% custom fee, and shows that `DynamicSwapFeeModule.getFee` returns 200_000 while `CLFactory.getSwapFee` still returns the base 500 ppm. PoC source ( `cl/test/PoC_DynamicFee_ClampToDefault.t.sol` ): // SPDX-License-Identifier: MIT pragma solidity 0.7.6; pragma abicoder v2; import \"forge-std/Test.sol\"; import {C4PoCTestbed} from \"./C4PoCTestbed.t.sol\"; import {DynamicSwapFeeModule} from \"contracts/core/fees/DynamicSwapFeeModule.sol\"; contract PoC_DynamicFee_ClampToDefault is C4PoCTestbed { address internal pool; function setUp() public override { super.setUp(); pool = poolFactory.createPool(USDC, DAI, 100, uint160(2 ** 96)); require(pool != address(0), \"pool not created\"); } function testFactoryClampsFeeAboveTenPercent() public { address manager = poolFactory.swapFeeManager(); vm.prank(manager); swapFeeModule.setFeeCap(pool, 500_000); // raise module cap to 50% vm.prank(manager); swapFeeModule.setScalingFactor(pool, 1); // ensure positive TWAP delta doesn't zero fee uint24 highFee = 200_000; // 20% vm.prank(manager); swapFeeModule.setCustomFee(pool, highFee); uint24 moduleFee = swapFeeModule.getFee(pool); assertEq(uint256(moduleFee), uint256(highFee), \"module reports configured fee\"); uint24 factoryFee = poolFactory.getSwapFee(pool); assertEq(uint256(factoryFee), 500, \"factory silently clamps to tick-spacing default\"); } }",
    "impact": "Severity: medium",
    "correct_fix": "Either revert when the module returns > 100_000 or raise the factory ceiling to match the module\u2019s cap. Emit events or add admin tooling to surface out-of-range configurations so operators can correct them. Hybra Finance mitigated: Added setMaxFee() function to make the fee cap configurable by the owner (up to 50%). This replaces the hardcoded limit and allows governance to adjust the maximum dynamic fee when needed."
  },
  "provenance": {
    "source": "code4rena",
    "original_id": "gs_c4_2025-10-hybra-finance_M01",
    "url": "https://code4rena.com/reports/2025-10-hybra-finance",
    "date_discovered": "2025-10-06",
    "date_added": "2025-12-16",
    "added_by": "benchmark_team"
  },
  "code_metadata": {
    "solidity_version": "^0.8.0",
    "num_lines": 273,
    "num_contracts": 1,
    "contract_names": [],
    "num_functions": 0,
    "has_imports": false,
    "imports": [],
    "has_inheritance": false,
    "inherits_from": [],
    "has_modifiers": false,
    "has_events": false,
    "has_assembly": false,
    "compilation_verified": false,
    "compiler_version_used": null
  },
  "tags": [
    "logic_error",
    "code4rena",
    "gold_standard",
    "audit_finding"
  ],
  "notes": "The factory silently clamps dynamic fees above 10% to a low default, misleading governance about effective fee rates.",
  "gold_standard_fields": {
    "source_report": "2025-10-hybra-finance",
    "source_finding_id": "M-01",
    "finding_title": "CLFactory ignores dynamic fees above 10% and silently falls back to default",
    "difficulty_tier": 1,
    "context_level": "single_file",
    "has_context": false,
    "call_flow": "Governance.setCustomFee() -> DynamicSwapFeeModule.getFee() (>10%) -> CLFactory.getSwapFee() -> returns default fee"
  },
  "evaluation_support": {
    "annotated_contract": "labelled_data/gold_standard/contracts/gs_002.sol",
    "detailed_metadata": "labelled_data/gold_standard/metadata/gs_002.json",
    "original_finding_title": "CLFactory ignores dynamic fees above 10% and silently falls back to default"
  },
  "original_subset": "gold_standard",
  "original_contract_file": "base/contracts/gs_002.sol",
  "sanitized_from": "gs_002",
  "identifier_mappings": {
    "excessivelySafeStaticCall": "_0x787e5a",
    "cachedUnstakedFeeManager": "_0x2eed3b",
    "collectAllProtocolFees": "_0xf12dba",
    "setProtocolFeeManager": "_0x1e2752",
    "setDefaultUnstakedFee": "_0xfc8b6c",
    "setUnstakedFeeManager": "_0x7817f5",
    "setUnstakedFeeModule": "_0x69fc59",
    "setProtocolFeeModule": "_0x63783d",
    "cachedSwapFeeManager": "_0x4c31f3",
    "_unstakedFeeManager": "_0x9d9800",
    "isGaugeAliveForPool": "_0xf20f20",
    "collectProtocolFees": "_0x654169",
    "_poolImplementation": "_0xa76639",
    "_defaultUnstakedFee": "_0xbe0959",
    "_protocolFeeManager": "_0x2143c1",
    "unstakedFeeManager": "_0x18bd68",
    "_protocolFeeModule": "_0x504b35",
    "_unstakedFeeModule": "_0x0586bd",
    "defaultProtocolFee": "_0xdb06c8",
    "protocolFeeManager": "_0xd7f335",
    "encodeWithSelector": "_0x860ad3",
    "cloneDeterministic": "_0x39a858",
    "defaultUnstakedFee": "_0x2653d0",
    "poolImplementation": "_0xb7c069",
    "setSwapFeeManager": "_0x3b4584",
    "enableTickSpacing": "_0x8952b7",
    "unstakedFeeModule": "_0xffb831",
    "protocolFeeModule": "_0x4b3f24",
    "setSwapFeeModule": "_0xda3412",
    "tickSpacingToFee": "_0x2bc0e0",
    "setGaugeManager": "_0xf83870",
    "_swapFeeManager": "_0xa25f89",
    "getProtocolFee": "_0x147c82",
    "swapFeeManager": "_0xaa9187",
    "_swapFeeModule": "_0x2614b0",
    "allPoolsLength": "_0x16532e",
    "oldUnstakedFee": "_0x71a0d3",
    "getUnstakedFee": "_0xc10f2d",
    "_tickSpacings": "_0x03628c",
    "_sqrtPriceX96": "_0xedf8bf",
    "swapFeeModule": "_0x451f02",
    "_gaugeManager": "_0x013efc",
    "sqrtPriceX96": "_0x112e82",
    "tickSpacings": "_0x8104f0",
    "oldFeeModule": "_0x701d73",
    "_tickSpacing": "_0xecd0dd",
    "gaugeManager": "_0xe52cc6",
    "tickSpacing": "_0x55912e",
    "cachedOwner": "_0x618eaa",
    "initialize": "_0x2766b4",
    "createPool": "_0x9b63d2",
    "getSwapFee": "_0x3ee766",
    "keccak256": "_0x1c066c",
    "setOwner": "_0x22b0e1",
    "_factory": "_0xca2efc",
    "allPools": "_0x4cdfec",
    "amount1": "_0x712772",
    "amount0": "_0xf9af62",
    "getPool": "_0xf32bfc",
    "success": "_0x6a9fea",
    "_isPool": "_0x710ebb",
    "_token1": "_0x603874",
    "_token0": "_0x895f12",
    "decode": "_0xba67dd",
    "token0": "_0xb26d71",
    "_owner": "_0x42d2ad",
    "isPool": "_0x434d7b",
    "tokenB": "_0x9966a8",
    "getFee": "_0x9bd4ae",
    "token1": "_0xea05b0",
    "encode": "_0xd7af57",
    "tokenA": "_0xabc4c9",
    "master": "_0xd8ee6b",
    "owner": "_0x059933",
    "salt": "_0x65de7e",
    "pool": "_0xc986c7",
    "fee": "_0xcc5934"
  },
  "derived_from": "sn_gs_002",
  "transformation": {
    "strategy": "shapeshifter",
    "level": "l3",
    "variant": "medium",
    "source": "sanitized",
    "changes": [
      "Renamed 77 identifiers using hex style",
      "Wrapped assignment in conditional",
      "Wrapped assignment in conditional",
      "Wrapped assignment in conditional",
      "Wrapped assignment in conditional",
      "Wrapped assignment in conditional"
    ],
    "rename_map_size": 77,
    "metadata_changes": [
      "Transformed ground_truth.vulnerable_location.function_name: getSwapFee \u2192 _0x3ee766"
    ]
  }
}