{
  "id": "ss_l3_medium_nc_gs_002",
  "contract_file": "contracts/ss_l3_medium_nc_gs_002.sol",
  "subset": "shapeshifter",
  "ground_truth": {
    "is_vulnerable": true,
    "vulnerability_type": "logic_error",
    "severity": "medium",
    "vulnerable_location": {
      "contract_name": "CLFactory",
      "function_name": "_0x2afc66",
      "line_numbers": []
    },
    "root_cause": "Governance can configure `DynamicSwapFeeModule` with fees up to 50%, but `CLFactory.getSwapFee` discards any value above 100_000 ppm (10%) and falls back to the tick-spacing default (often 500 ppm = 0.05%) without reverting or logging. Operators see the module reporting 20%, yet users continue paying the tiny default fee. The silent fallback misleads governance into believing higher fees are active. Impact - Governance believes a protective high fee is set (e.g., during launch anti-MEV), but the effective fee drops back to the default (e.g., 0.05%). - Traders are charged far less than intended, defeating protective or revenue objectives. - The misconfiguration has no on-chain signal, so the mistake can persist unnoticed. Root Cause - getSwapFee checks fee <= 100_000 ; larger values are ignored and the function returns tickSpacingToFee . - The module itself allows feeCap up to 500_000 (50%), so governance can set a value the factory immediately discards in favor of the default.",
    "attack_vector": "cd cl forge test --match-path test/PoC_DynamicFee_ClampToDefault.t.sol -vvv The PoC lifts the module cap, sets a 20% custom fee, and shows that `DynamicSwapFeeModule.getFee` returns 200_000 while `CLFactory.getSwapFee` still returns the base 500 ppm. PoC source ( `cl/test/PoC_DynamicFee_ClampToDefault.t.sol` ): // SPDX-License-Identifier: MIT pragma solidity 0.7.6; pragma abicoder v2; import \"forge-std/Test.sol\"; import {C4PoCTestbed} from \"./C4PoCTestbed.t.sol\"; import {DynamicSwapFeeModule} from \"contracts/core/fees/DynamicSwapFeeModule.sol\"; contract PoC_DynamicFee_ClampToDefault is C4PoCTestbed { address internal pool; function setUp() public override { super.setUp(); pool = poolFactory.createPool(USDC, DAI, 100, uint160(2 ** 96)); require(pool != address(0), \"pool not created\"); } function testFactoryClampsFeeAboveTenPercent() public { address manager = poolFactory.swapFeeManager(); vm.prank(manager); swapFeeModule.setFeeCap(pool, 500_000); // raise module cap to 50% vm.prank(manager); swapFeeModule.setScalingFactor(pool, 1); // ensure positive TWAP delta doesn't zero fee uint24 highFee = 200_000; // 20% vm.prank(manager); swapFeeModule.setCustomFee(pool, highFee); uint24 moduleFee = swapFeeModule.getFee(pool); assertEq(uint256(moduleFee), uint256(highFee), \"module reports configured fee\"); uint24 factoryFee = poolFactory.getSwapFee(pool); assertEq(uint256(factoryFee), 500, \"factory silently clamps to tick-spacing default\"); } }",
    "impact": "Severity: medium",
    "correct_fix": "Either revert when the module returns > 100_000 or raise the factory ceiling to match the module\u2019s cap. Emit events or add admin tooling to surface out-of-range configurations so operators can correct them. Hybra Finance mitigated: Added setMaxFee() function to make the fee cap configurable by the owner (up to 50%). This replaces the hardcoded limit and allows governance to adjust the maximum dynamic fee when needed."
  },
  "provenance": {
    "source": "code4rena",
    "original_id": "gs_c4_2025-10-hybra-finance_M01",
    "url": "https://code4rena.com/reports/2025-10-hybra-finance",
    "date_discovered": "2025-10-06",
    "date_added": "2025-12-16",
    "added_by": "benchmark_team"
  },
  "code_metadata": {
    "solidity_version": "^0.8.0",
    "num_lines": 273,
    "num_contracts": 1,
    "contract_names": [],
    "num_functions": 0,
    "has_imports": false,
    "imports": [],
    "has_inheritance": false,
    "inherits_from": [],
    "has_modifiers": false,
    "has_events": false,
    "has_assembly": false,
    "compilation_verified": false,
    "compiler_version_used": null
  },
  "tags": [
    "logic_error",
    "code4rena",
    "gold_standard",
    "audit_finding"
  ],
  "notes": "The factory silently clamps dynamic fees above 10% to a low default, misleading governance about effective fee rates.",
  "gold_standard_fields": {
    "source_report": "2025-10-hybra-finance",
    "source_finding_id": "M-01",
    "finding_title": "CLFactory ignores dynamic fees above 10% and silently falls back to default",
    "difficulty_tier": 1,
    "context_level": "single_file",
    "has_context": false,
    "call_flow": "Governance.setCustomFee() -> DynamicSwapFeeModule.getFee() (>10%) -> CLFactory.getSwapFee() -> returns default fee"
  },
  "evaluation_support": {
    "annotated_contract": "labelled_data/gold_standard/contracts/gs_002.sol",
    "detailed_metadata": "labelled_data/gold_standard/metadata/gs_002.json",
    "original_finding_title": "CLFactory ignores dynamic fees above 10% and silently falls back to default"
  },
  "original_subset": "gold_standard",
  "original_contract_file": "base/contracts/gs_002.sol",
  "sanitized_from": "gs_002",
  "derived_from": "nc_gs_002",
  "original_id": "gs_002",
  "identifier_mappings": {
    "excessivelySafeStaticCall": "_0x9eae80",
    "cachedUnstakedFeeManager": "_0x9faecc",
    "collectAllProtocolFees": "_0x524319",
    "setUnstakedFeeManager": "_0xb3f207",
    "setProtocolFeeManager": "_0xcbb83d",
    "setDefaultUnstakedFee": "_0x3baa96",
    "setUnstakedFeeModule": "_0x7fc888",
    "setProtocolFeeModule": "_0xc7ec5e",
    "cachedSwapFeeManager": "_0x7d0012",
    "_defaultUnstakedFee": "_0x6e008f",
    "_unstakedFeeManager": "_0x0a29f9",
    "_protocolFeeManager": "_0xe96d7b",
    "collectProtocolFees": "_0x474451",
    "isGaugeAliveForPool": "_0x3e9a5e",
    "_poolImplementation": "_0x2441bd",
    "encodeWithSelector": "_0xf11961",
    "cloneDeterministic": "_0x1e1956",
    "_protocolFeeModule": "_0xcbf5bd",
    "defaultProtocolFee": "_0xd5f787",
    "protocolFeeManager": "_0x3a048c",
    "poolImplementation": "_0xcf3bb5",
    "unstakedFeeManager": "_0x0db91f",
    "defaultUnstakedFee": "_0x3ce125",
    "_unstakedFeeModule": "_0x792067",
    "unstakedFeeModule": "_0x6749c7",
    "protocolFeeModule": "_0x684fcb",
    "enableTickSpacing": "_0x54b56d",
    "setSwapFeeManager": "_0xe3093b",
    "setSwapFeeModule": "_0x3f64f6",
    "tickSpacingToFee": "_0x8697e7",
    "_swapFeeManager": "_0xc2ef63",
    "setGaugeManager": "_0xf3ee2f",
    "getUnstakedFee": "_0x5bd54a",
    "oldUnstakedFee": "_0xc5556b",
    "getProtocolFee": "_0x8a00ec",
    "swapFeeManager": "_0xa4020c",
    "_swapFeeModule": "_0xcf86d3",
    "allPoolsLength": "_0xbf6390",
    "_gaugeManager": "_0x2265ca",
    "_tickSpacings": "_0x873bbb",
    "swapFeeModule": "_0xd05956",
    "_sqrtPriceX96": "_0xe13ba5",
    "tickSpacings": "_0x86ff88",
    "sqrtPriceX96": "_0xb81d71",
    "_tickSpacing": "_0x7ad480",
    "gaugeManager": "_0x402000",
    "oldFeeModule": "_0xa7ba63",
    "tickSpacing": "_0xde7b87",
    "cachedOwner": "_0x7463a9",
    "createPool": "_0xd5587b",
    "initialize": "_0x5c9499",
    "getSwapFee": "_0x2afc66",
    "keccak256": "_0x0a55ee",
    "setOwner": "_0x3d4aaf",
    "_factory": "_0x3d9dcc",
    "allPools": "_0x09943c",
    "_token0": "_0x67d9df",
    "_token1": "_0xb1ccaf",
    "amount1": "_0xb7bcfa",
    "_isPool": "_0x1fd1e0",
    "success": "_0x981351",
    "getPool": "_0xa8096c",
    "amount0": "_0x110bdd",
    "master": "_0xd27af9",
    "token0": "_0x1e58fe",
    "tokenA": "_0xef9104",
    "tokenB": "_0x7605fe",
    "decode": "_0xaaebce",
    "isPool": "_0xd393de",
    "getFee": "_0x8dd788",
    "token1": "_0xe80e32",
    "encode": "_0x64923d",
    "_owner": "_0x44b854",
    "owner": "_0x46a8a6",
    "pool": "_0xcc40d0",
    "salt": "_0x912d8d",
    "fee": "_0x4bac0b"
  },
  "transformation": {
    "strategy": "shapeshifter",
    "level": "l3",
    "variant": "medium",
    "source": "nocomments",
    "changes": [
      "Renamed 77 identifiers using hex style",
      "Wrapped assignment in conditional",
      "Wrapped assignment in conditional",
      "Wrapped assignment in conditional",
      "Wrapped assignment in conditional",
      "Wrapped assignment in conditional"
    ],
    "rename_map_size": 77,
    "metadata_changes": [
      "Transformed ground_truth.vulnerable_location.function_name: getSwapFee \u2192 _0x2afc66"
    ]
  }
}