schema_version: "1.0"
sample_id: "ms_tc_012"
vulnerability_type: "reentrancy"
vulnerable_lines: [68, 71]

# Full line coverage for scoring. UNRELATED items are batched for efficiency.
# Detailed rationales only for security-relevant code acts.

code_acts:

  # ============================================
  # SECURITY-RELEVANT CODE ACTS (detailed)
  # ============================================

  - id: "CA1"
    type: "DECLARATION"
    lines: [19]
    code: "mapping(address => uint256) public deposits;"
    security_function: "PREREQ"
    rationale: "PREREQ - User deposit mapping read for collateral checks. Enables reentrancy impact calculation."

  - id: "CA2"
    type: "DECLARATION"
    lines: [20]
    code: "mapping(address => uint256) public borrowed;"
    security_function: "PREREQ"
    rationale: "PREREQ - User borrowed amount tracking. Updated before external call, read in health checks."

  - id: "CA3"
    type: "DECLARATION"
    lines: [21]
    code: "mapping(address => bool) public inMarket;"
    security_function: "PREREQ"
    rationale: "PREREQ - Market participation flag checked in isHealthy(). Can be manipulated via exitMarket during reentrancy."

  - id: "CA4"
    type: "STATE_MOD"
    lines: [35, 36, 37]
    code: |
      deposits[msg.sender] += msg.value;
      totalDeposits += msg.value;
      inMarket[msg.sender] = true;
    security_function: "BENIGN"
    rationale: "Deposit function state updates. Correctly implemented."

  - id: "CA5"
    type: "INPUT_VAL"
    lines: [47, 48]
    code: |
      uint256 totalDebt = borrowed[account] + additionalBorrow;
      if (totalDebt == 0) return true;
    security_function: "BENIGN"
    rationale: "Debt calculation in isHealthy. Correctly returns true if no debt."

  - id: "CA6"
    type: "INPUT_VAL"
    lines: [51]
    code: "if (!inMarket[account]) return false;"
    security_function: "PREREQ"
    rationale: "PREREQ - Market check that can be bypassed. If attacker exits market during reentrancy, this returns false in subsequent health checks."

  - id: "CA7"
    type: "COMPUTATION"
    lines: [53, 54]
    code: |
      uint256 collateralValue = deposits[account];
      return collateralValue >= (totalDebt * COLLATERAL_FACTOR) / 100;
    security_function: "BENIGN"
    rationale: "Collateral ratio calculation. Math is correct."

  - id: "CA8"
    type: "INPUT_VAL"
    lines: [58, 59]
    code: |
      require(amount > 0, "Invalid amount");
      require(address(this).balance >= amount, "Insufficient funds");
    security_function: "BENIGN"
    rationale: "Basic input validation in borrow(). Correctly implemented."

  - id: "CA9"
    type: "INPUT_VAL"
    lines: [62]
    code: 'require(isHealthy(msg.sender, amount), "Insufficient collateral");'
    security_function: "PREREQ"
    rationale: "PREREQ - Initial health check before borrow. Passes on first call but may behave differently during reentrancy."

  - id: "CA10"
    type: "STATE_MOD"
    lines: [65, 66]
    code: |
      borrowed[msg.sender] += amount;
      totalBorrowed += amount;
    security_function: "PREREQ"
    rationale: "PREREQ - State updated BEFORE external call. During reentrancy, this is already updated which should prevent additional borrows, but the external call happens next."

  - id: "CA11"
    type: "EXT_CALL"
    lines: [68, 69]
    code: |
      (bool success, ) = payable(msg.sender).call{value: amount}("");
      require(success, "Transfer failed");
    security_function: "ROOT_CAUSE"
    rationale: "ROOT_CAUSE - External call sending ETH before final health check. Attacker can reenter during this call. While borrowed state is updated, attacker can manipulate other state (exitMarket) to affect health calculations."

  - id: "CA12"
    type: "INPUT_VAL"
    lines: [71]
    code: 'require(isHealthy(msg.sender, 0), "Health check failed");'
    security_function: "ROOT_CAUSE"
    rationale: "ROOT_CAUSE - Health check AFTER external call. This check can be manipulated via reentrancy - attacker can call exitMarket during the external call to change inMarket status."

  - id: "CA13"
    type: "INPUT_VAL"
    lines: [75]
    code: 'require(borrowed[msg.sender] == 0, "Outstanding debt");'
    security_function: "PREREQ"
    rationale: "PREREQ - Debt check in exitMarket. Prevents exiting with debt, but this can be called after borrow state is updated and before final check."

  - id: "CA14"
    type: "STATE_MOD"
    lines: [76]
    code: "inMarket[msg.sender] = false;"
    security_function: "PREREQ"
    rationale: "PREREQ - Sets inMarket to false. If called during reentrancy, subsequent isHealthy checks would return false at line 51."

  - id: "CA15"
    type: "INPUT_VAL"
    lines: [83, 84]
    code: |
      require(deposits[msg.sender] >= amount, "Insufficient deposits");
      require(!inMarket[msg.sender], "Exit market first");
    security_function: "BENIGN"
    rationale: "Withdrawal validation. Correctly requires exiting market first."

  - id: "CA16"
    type: "STATE_MOD"
    lines: [86, 87]
    code: |
      deposits[msg.sender] -= amount;
      totalDeposits -= amount;
    security_function: "BENIGN"
    rationale: "Withdrawal state updates. Correctly implemented."

  - id: "CA17"
    type: "EXT_CALL"
    lines: [89]
    code: "payable(msg.sender).transfer(amount);"
    security_function: "BENIGN"
    rationale: "ETH transfer in withdraw. Uses transfer() with 2300 gas limit."

  # ============================================
  # BATCHED UNRELATED CODE ACTS (for scoring)
  # ============================================

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma statements"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: [31, 32, 33, 40, 41, 42, 50, 61, 64, 79, 80, 81]
    security_function: "UNRELATED"
    rationale: "Inline comments and NatSpec documentation"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [4, 5, 6, 7, 9, 11, 12, 13, 14, 16, 17, 23, 24, 25, 27, 28, 29, 34, 43, 44, 45, 46, 57, 74, 82, 90, 92, 93]
    security_function: "UNRELATED"
    rationale: "Interface, contract, constant, constructor, and function signature declarations"

  - id: "CA_SYNTAX"
    type: "SYNTAX"
    lines: [38, 55, 72, 77]
    security_function: "UNRELATED"
    rationale: "Closing braces"

summary:
  total_code_acts: 20
  total_lines_covered: 72  # excludes 22 empty lines

  by_security_function:
    ROOT_CAUSE: 2      # CA11, CA12
    PREREQ: 6          # CA1, CA2, CA3, CA6, CA9, CA10, CA13, CA14
    BENIGN: 8          # CA4, CA5, CA7, CA8, CA15, CA16, CA17
    UNRELATED: 4       # batched

  root_causes:
    - id: "CA11"
      lines: [68, 69]
      type: "EXT_CALL"
      description: "External call sending ETH before final health check"
    - id: "CA12"
      line: 71
      type: "INPUT_VAL"
      description: "Health check after external call can be manipulated"

  prerequisites:
    - id: "CA1"
      description: "Deposit mapping for collateral"
    - id: "CA2"
      description: "Borrowed mapping tracking"
    - id: "CA3"
      description: "Market participation flag"
    - id: "CA6"
      description: "Market check in isHealthy"
    - id: "CA10"
      description: "State update before external call"
    - id: "CA14"
      description: "exitMarket state change"

line_to_code_act:
  # Directives (UNRELATED)
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  # Line 3: empty
  # IComptroller interface (UNRELATED)
  4: "CA_DECLARATIONS"
  5: "CA_DECLARATIONS"
  6: "CA_DECLARATIONS"
  7: "CA_DECLARATIONS"
  # Line 8: empty
  9: "CA_DECLARATIONS"
  # Line 10: empty
  11: "CA_DECLARATIONS"
  12: "CA_DECLARATIONS"
  13: "CA_DECLARATIONS"
  14: "CA_DECLARATIONS"
  # Line 15: empty
  # RariFuse contract
  16: "CA_DECLARATIONS"
  17: "CA_DECLARATIONS"
  # Line 18: empty
  19: "CA1"
  20: "CA2"
  21: "CA3"
  # Line 22: empty
  23: "CA_DECLARATIONS"
  24: "CA_DECLARATIONS"
  25: "CA_DECLARATIONS"
  # Line 26: empty
  27: "CA_DECLARATIONS"
  28: "CA_DECLARATIONS"
  29: "CA_DECLARATIONS"
  # Line 30: empty
  31: "CA_COMMENTS"
  32: "CA_COMMENTS"
  33: "CA_COMMENTS"
  34: "CA_DECLARATIONS"
  35: "CA4"
  36: "CA4"
  37: "CA4"
  38: "CA_SYNTAX"
  # Line 39: empty
  40: "CA_COMMENTS"
  41: "CA_COMMENTS"
  42: "CA_COMMENTS"
  43: "CA_DECLARATIONS"
  44: "CA_DECLARATIONS"
  45: "CA_DECLARATIONS"
  46: "CA_DECLARATIONS"
  47: "CA5"
  48: "CA5"
  # Line 49: empty
  50: "CA_COMMENTS"
  51: "CA6"
  # Line 52: empty
  53: "CA7"
  54: "CA7"
  55: "CA_SYNTAX"
  # Line 56: empty
  57: "CA_DECLARATIONS"
  58: "CA8"
  59: "CA8"
  # Line 60: empty
  61: "CA_COMMENTS"
  62: "CA9"
  # Line 63: empty
  64: "CA_COMMENTS"
  65: "CA10"
  66: "CA10"
  # Line 67: empty
  68: "CA11"
  69: "CA11"
  # Line 70: empty
  71: "CA12"
  72: "CA_SYNTAX"
  # Line 73: empty
  74: "CA_DECLARATIONS"
  75: "CA13"
  76: "CA14"
  77: "CA_SYNTAX"
  # Line 78: empty
  79: "CA_COMMENTS"
  80: "CA_COMMENTS"
  81: "CA_COMMENTS"
  82: "CA_DECLARATIONS"
  83: "CA15"
  84: "CA15"
  # Line 85: empty
  86: "CA16"
  87: "CA16"
  # Line 88: empty
  89: "CA17"
  90: "CA_DECLARATIONS"
  # Line 91: empty
  92: "CA_DECLARATIONS"
  93: "CA_DECLARATIONS"

code_act_security_functions:
  CA1: "PREREQ"
  CA2: "PREREQ"
  CA3: "PREREQ"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "PREREQ"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "PREREQ"
  CA10: "PREREQ"
  CA11: "ROOT_CAUSE"
  CA12: "ROOT_CAUSE"
  CA13: "PREREQ"
  CA14: "PREREQ"
  CA15: "BENIGN"
  CA16: "BENIGN"
  CA17: "BENIGN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"
  CA_SYNTAX: "UNRELATED"
