{
  "id": "gs_036",
  "original_id": "gs_quantstamp_startale_sta001",
  "source_dataset": "gold_standard",
  "vulnerability_type": "economic_attack",
  "severity": "high",
  "difficulty_tier": 4,
  "context_level": "cross_contract",
  "is_vulnerable": true,
  "finding_title": "Leveraged TVL Manipulation via Sandwich Attack on distribute()",
  "finding_description": "The RewardRedistributor's distribute() function reads the sUSDSC vault's totalAssets() at execution time to calculate yield splits. An attacker can build a leveraged position in the sUSDSC vault using a lending pool (e.g., Aave-style), sandwich the distribute() transaction, and capture disproportionate yield while stealing from EarnVault users. The attack uses borrowed USDSC as collateral in recursive loops to artificially inflate sUSDSC's TVL, manipulating the yield distribution formula.",
  "vulnerable_lines": [
    108,
    109,
    110,
    113,
    120,
    143,
    144,
    145,
    147,
    148,
    149,
    155,
    156,
    157,
    158,
    159,
    160,
    161,
    162
  ],
  "vulnerable_functions": [
    "distribute",
    "_calculateSplit"
  ],
  "has_context": true,
  "attack_scenario": "1. Attacker detects operator's distribute() transaction in mempool\n2. Attacker frontruns with leverage loop (5 iterations): Deposit 1M USDSC \u2192 get 1M sUSDSC \u2192 borrow 900k USDSC. Deposit 900k \u2192 get 900k sUSDSC \u2192 borrow 810k. Continue until 4.095M total deposited using 3.685M borrowed + 1M original capital\n3. This inflates sUSDSC vault from 10M to 14.095M USDSC\n4. Operator's distribute() executes with manipulated TVL: Normal split would be toEarn=316,667 USDSC, toOn=633,333 USDSC. Manipulated split: toEarn=248,752 USDSC (lost 67,915), toOn=701,248 USDSC (gained 67,915). Attacker's 4.095M shares (29% of vault) capture 203,693 USDSC of inflated yield\n5. Attacker backruns: Redeem 4.095M shares for 4,298,693 USDSC, repay 3.685M loan (interest ~1.4 USDSC for 2 minutes), net profit 203,191 USDSC per attack\n6. Attack repeatable 6 times daily = 1.2M USDSC profit/day = 445M USDSC profit/year (44,493% APY)",
  "fix_description": "Implement snapshot-based TVL mechanism to prevent same-block manipulation. In RewardRedistributor.sol: (1) Add storage: uint256 public lastSUSDSCTVL; uint256 public lastSnapshotBlock; (2) Add function snapshotTVL() external onlyRole(OPERATOR_ROLE) { lastSUSDSCTVL = susdscVault.totalAssets(); lastSnapshotBlock = block.number; } (3) In distribute() require(lastSnapshotBlock == block.number - 1, 'Must snapshot in previous block') and use lastSUSDSCTVL instead of susdscVault.totalAssets() (4) Operator workflow: Call snapshotTVL() in block N, then call distribute() in block N+1. This forces attacker to hold leveraged position for minimum 1 full block (~12 seconds), making attack 100x more expensive (5) For defense-in-depth, add 1-hour withdrawal cooldown to sUSDSC vault and minimum time post-deposit during which funds cannot be withdrawn",
  "expert_notes": "This vulnerability is similar to the Curve donation attack but exploits the yield distribution mechanism rather than share accounting. The key insight is that RewardRedistributor trusts the sUSDSC vault's spot totalAssets() without considering that TVL can be manipulated within the same transaction via flashloans or multi-step leveraging. The fix requires understanding both ERC4626 mechanics and MEV attack vectors.",
  "context_hint": "ERC4626 share accounting is fair - attacker gets correct shares at deposit and correct assets at redemption. The vulnerability exists because distribute() uses spot totalAssets() instead of a time-delayed snapshot. This is a sophisticated economic attack that requires understanding both lending pool mechanics and yield distribution formulas. The attacker can execute this profitably multiple times daily with modest capital due to Aave-style 90% LTV.",
  "call_flow": "Attacker.detectMempool() \u2192 Attacker.frontRun() \u2192 Attacker.borrowAndDeposit() \u2192 inflate sUSDSC.totalAssets() \u2192 Operator.distribute() \u2192 RewardDistributor.distribute() reads spot TVL \u2192 manipulated yield split \u2192 Attacker.backRun() \u2192 Attacker.repayAndProfit()"
}