{
  "id": "gs_015",
  "original_id": "gs_spearbit_aragon-lock-to-vote_M03",
  "source_dataset": "gold_standard",
  "source_file": "aragon.json",
  "language": "solidity",
  "chain": "ethereum",
  "source_platform": "spearbit",
  "source_report": "Aragon DAO Gov Plugin Security Review",
  "source_finding_id": "M-03",
  "report_url": "https://github.com/spearbit/portfolio/blob/master/pdfs/Aragon-Spearbit-Security-Review-July-2025.pdf",
  "github_repo_url": "https://github.com/aragon/lock-to-vote-plugin/tree/b3c5503c",
  "contest_date": "2025-09-11",
  "vulnerability_type": "logic_error",
  "severity": "medium",
  "difficulty_tier": 2,
  "context_level": "multi_file",
  "is_vulnerable": true,
  "finding_title": "Misuse of isProposalOpen() function",
  "finding_description": "The isProposalOpen() function returns true if a proposal is open for voting. It returns false if it's too late OR too early for voting. But in _withdrawActiveVotingPower() at line 225, it was being used as an 'isProposalStillOpen()' function, forgetting that it will also be false when the proposal hasn't started yet. This means proposals with future start dates get incorrectly removed from knownProposalIds tracking.",
  "attack_scenario": "1. A proposal is created with a future start date (e.g., starts in 1 week).\n2. User calls unlock() before the proposal starts.\n3. _withdrawActiveVotingPower() is called at line 135.\n4. Line 225: plugin.isProposalOpen(_proposalId) returns false (proposal hasn't started).\n5. Line 226: knownProposalIds.remove(_proposalId) - proposal removed from tracking.\n6. Proposal starts a week later, user votes.\n7. User calls unlock() again - vote isn't cleared because proposal isn't tracked.\n8. User withdraws tokens while still having active votes.",
  "fix_description": "Create and use an isProposalEnded() function specifically for this use case. It should return true only if the proposal has actually ended (endDate passed or executed), not just because it hasn't started.",
  "call_flow": "User.unlock() -> LockManagerBase._withdrawActiveVotingPower() -> line 225: plugin.isProposalOpen() returns false (not started yet) -> line 226: knownProposalIds.remove() -> proposal starts later -> User.vote() -> User.unlock() succeeds without clearing vote",
  "context_hint": "The _isProposalOpen() function (MajorityVotingBase line 578) checks 'startDate <= currentTime && currentTime < endDate'. This returns false for proposals that haven't started YET. The _withdrawActiveVotingPower() incorrectly uses this to detect ended proposals, causing future-dated proposals to be removed from tracking prematurely.",
  "primary_file_path": "src/base/LockManagerBase.sol",
  "vulnerable_lines": [
    221,
    222,
    223,
    224,
    225,
    226,
    227,
    228,
    229,
    230,
    231,
    232,
    233,
    234,
    235,
    236,
    237,
    238,
    239,
    240,
    241,
    242,
    243,
    244,
    245,
    246
  ],
  "vulnerable_functions": [
    "_withdrawActiveVotingPower"
  ],
  "context_files": [
    {
      "filename": "context_01_MajorityVotingBase.sol",
      "original_path": "src/base/MajorityVotingBase.sol",
      "relevance": "Contains _isProposalOpen() at lines 575-579 which returns false for both ended AND not-yet-started proposals. The fix adds a separate _isProposalEnded() function."
    }
  ],
  "has_context": true
}