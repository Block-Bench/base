{
  "id": "ss_l3_medium_nc_gs_002",
  "contract_file": "contracts/ss_l3_medium_nc_gs_002.sol",
  "subset": "shapeshifter",
  "ground_truth": {
    "is_vulnerable": true,
    "vulnerability_type": "logic_error",
    "severity": "medium",
    "vulnerable_location": {
      "contract_name": "CLFactory",
      "function_name": "_0x468b65",
      "line_numbers": []
    },
    "root_cause": "Governance can configure `DynamicSwapFeeModule` with fees up to 50%, but `CLFactory.getSwapFee` discards any value above 100_000 ppm (10%) and falls back to the tick-spacing default (often 500 ppm = 0.05%) without reverting or logging. Operators see the module reporting 20%, yet users continue paying the tiny default fee. The silent fallback misleads governance into believing higher fees are active. Impact - Governance believes a protective high fee is set (e.g., during launch anti-MEV), but the effective fee drops back to the default (e.g., 0.05%). - Traders are charged far less than intended, defeating protective or revenue objectives. - The misconfiguration has no on-chain signal, so the mistake can persist unnoticed. Root Cause - getSwapFee checks fee <= 100_000 ; larger values are ignored and the function returns tickSpacingToFee . - The module itself allows feeCap up to 500_000 (50%), so governance can set a value the factory immediately discards in favor of the default.",
    "attack_vector": "cd cl forge test --match-path test/PoC_DynamicFee_ClampToDefault.t.sol -vvv The PoC lifts the module cap, sets a 20% custom fee, and shows that `DynamicSwapFeeModule.getFee` returns 200_000 while `CLFactory.getSwapFee` still returns the base 500 ppm. PoC source ( `cl/test/PoC_DynamicFee_ClampToDefault.t.sol` ): // SPDX-License-Identifier: MIT pragma solidity 0.7.6; pragma abicoder v2; import \"forge-std/Test.sol\"; import {C4PoCTestbed} from \"./C4PoCTestbed.t.sol\"; import {DynamicSwapFeeModule} from \"contracts/core/fees/DynamicSwapFeeModule.sol\"; contract PoC_DynamicFee_ClampToDefault is C4PoCTestbed { address internal pool; function setUp() public override { super.setUp(); pool = poolFactory.createPool(USDC, DAI, 100, uint160(2 ** 96)); require(pool != address(0), \"pool not created\"); } function testFactoryClampsFeeAboveTenPercent() public { address manager = poolFactory.swapFeeManager(); vm.prank(manager); swapFeeModule.setFeeCap(pool, 500_000); // raise module cap to 50% vm.prank(manager); swapFeeModule.setScalingFactor(pool, 1); // ensure positive TWAP delta doesn't zero fee uint24 highFee = 200_000; // 20% vm.prank(manager); swapFeeModule.setCustomFee(pool, highFee); uint24 moduleFee = swapFeeModule.getFee(pool); assertEq(uint256(moduleFee), uint256(highFee), \"module reports configured fee\"); uint24 factoryFee = poolFactory.getSwapFee(pool); assertEq(uint256(factoryFee), 500, \"factory silently clamps to tick-spacing default\"); } }",
    "impact": "Severity: medium",
    "correct_fix": "Either revert when the module returns > 100_000 or raise the factory ceiling to match the module\u2019s cap. Emit events or add admin tooling to surface out-of-range configurations so operators can correct them. Hybra Finance mitigated: Added setMaxFee() function to make the fee cap configurable by the owner (up to 50%). This replaces the hardcoded limit and allows governance to adjust the maximum dynamic fee when needed."
  },
  "provenance": {
    "source": "code4rena",
    "original_id": "gs_c4_2025-10-hybra-finance_M01",
    "url": "https://code4rena.com/reports/2025-10-hybra-finance",
    "date_discovered": "2025-10-06",
    "date_added": "2025-12-16",
    "added_by": "benchmark_team"
  },
  "code_metadata": {
    "solidity_version": "^0.8.0",
    "num_lines": 273,
    "num_contracts": 1,
    "contract_names": [],
    "num_functions": 0,
    "has_imports": false,
    "imports": [],
    "has_inheritance": false,
    "inherits_from": [],
    "has_modifiers": false,
    "has_events": false,
    "has_assembly": false,
    "compilation_verified": false,
    "compiler_version_used": null
  },
  "tags": [
    "logic_error",
    "code4rena",
    "gold_standard",
    "audit_finding"
  ],
  "notes": "The factory silently clamps dynamic fees above 10% to a low default, misleading governance about effective fee rates.",
  "gold_standard_fields": {
    "source_report": "2025-10-hybra-finance",
    "source_finding_id": "M-01",
    "finding_title": "CLFactory ignores dynamic fees above 10% and silently falls back to default",
    "difficulty_tier": 1,
    "context_level": "single_file",
    "has_context": false,
    "call_flow": "Governance.setCustomFee() -> DynamicSwapFeeModule.getFee() (>10%) -> CLFactory.getSwapFee() -> returns default fee"
  },
  "evaluation_support": {
    "annotated_contract": "labelled_data/gold_standard/contracts/gs_002.sol",
    "detailed_metadata": "labelled_data/gold_standard/metadata/gs_002.json",
    "original_finding_title": "CLFactory ignores dynamic fees above 10% and silently falls back to default"
  },
  "original_subset": "gold_standard",
  "original_contract_file": "base/contracts/gs_002.sol",
  "sanitized_from": "gs_002",
  "derived_from": "nc_gs_002",
  "original_id": "gs_002",
  "identifier_mappings": {
    "excessivelySafeStaticCall": "_0xb358d5",
    "cachedUnstakedFeeManager": "_0x7649e5",
    "collectAllProtocolFees": "_0x672ac6",
    "setDefaultUnstakedFee": "_0x29444b",
    "setProtocolFeeManager": "_0xc411b7",
    "setUnstakedFeeManager": "_0xfcc8fa",
    "setProtocolFeeModule": "_0xcf6a2f",
    "cachedSwapFeeManager": "_0x882e45",
    "setUnstakedFeeModule": "_0xf44626",
    "_unstakedFeeManager": "_0x7b45e3",
    "isGaugeAliveForPool": "_0x9222d2",
    "_poolImplementation": "_0xae3b1a",
    "collectProtocolFees": "_0x503188",
    "_protocolFeeManager": "_0x4655fa",
    "_defaultUnstakedFee": "_0x9a6a34",
    "defaultProtocolFee": "_0x4d2968",
    "protocolFeeManager": "_0x2a66df",
    "defaultUnstakedFee": "_0x0d1af0",
    "_protocolFeeModule": "_0x56226b",
    "cloneDeterministic": "_0xead6e2",
    "unstakedFeeManager": "_0xc48d98",
    "encodeWithSelector": "_0x802783",
    "poolImplementation": "_0x4ca00b",
    "_unstakedFeeModule": "_0x80578f",
    "setSwapFeeManager": "_0x7ae328",
    "unstakedFeeModule": "_0x70688d",
    "protocolFeeModule": "_0x68b544",
    "enableTickSpacing": "_0x1ada88",
    "setSwapFeeModule": "_0xe8da42",
    "tickSpacingToFee": "_0x4163d7",
    "setGaugeManager": "_0x6f4d9b",
    "_swapFeeManager": "_0x874c10",
    "_swapFeeModule": "_0x6bacd7",
    "getProtocolFee": "_0xd2104f",
    "allPoolsLength": "_0x930eba",
    "getUnstakedFee": "_0x7079fa",
    "swapFeeManager": "_0x6b6a4e",
    "oldUnstakedFee": "_0xff4170",
    "_tickSpacings": "_0xf8978a",
    "_gaugeManager": "_0x1617fe",
    "swapFeeModule": "_0xee53b4",
    "_sqrtPriceX96": "_0xce784b",
    "sqrtPriceX96": "_0xe3ae5c",
    "tickSpacings": "_0x5ac7e1",
    "oldFeeModule": "_0xd30b73",
    "_tickSpacing": "_0x076231",
    "gaugeManager": "_0xcab18c",
    "cachedOwner": "_0x566970",
    "tickSpacing": "_0xf79cb4",
    "getSwapFee": "_0x468b65",
    "initialize": "_0x2dd747",
    "createPool": "_0x2d8b6b",
    "keccak256": "_0x24ee5d",
    "_factory": "_0x8fa0c4",
    "allPools": "_0xc80b88",
    "setOwner": "_0x12462f",
    "_isPool": "_0x92f8d7",
    "amount0": "_0xfec61e",
    "getPool": "_0x24afeb",
    "_token1": "_0x688cdf",
    "success": "_0xadde30",
    "amount1": "_0x9a8771",
    "_token0": "_0x946d7e",
    "isPool": "_0x552f0f",
    "getFee": "_0xe6b9f2",
    "master": "_0x8a0f15",
    "_owner": "_0x0b7346",
    "token0": "_0x9f5ae8",
    "tokenB": "_0x2371e7",
    "tokenA": "_0x187b29",
    "token1": "_0x3dd621",
    "decode": "_0xe2d6ce",
    "encode": "_0x222213",
    "owner": "_0x6c7b3d",
    "salt": "_0xbe90f1",
    "pool": "_0x6682b1",
    "fee": "_0x36e02d"
  },
  "transformation": {
    "strategy": "shapeshifter",
    "level": "l3",
    "variant": "medium",
    "source": "nocomments",
    "changes": [
      "Renamed 77 identifiers using hex style",
      "Wrapped assignment in conditional",
      "Wrapped assignment in conditional",
      "Wrapped assignment in conditional",
      "Wrapped assignment in conditional",
      "Wrapped assignment in conditional"
    ],
    "rename_map_size": 77,
    "metadata_changes": [
      "Transformed ground_truth.vulnerable_location.function_name: getSwapFee \u2192 _0x468b65"
    ]
  }
}