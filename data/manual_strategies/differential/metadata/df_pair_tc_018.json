{
  "pair_id": "df_pair_tc_018",
  "strategy": "differential",
  "variant": "minimal",
  "original_id": "tc_018",
  "original_subset": "temporal_contamination",
  "version_a": {
    "id": "df_a_tc_018",
    "file": "contracts/df_a_tc_018.sol",
    "is_vulnerable": false,
    "status": "safe",
    "description": "Fixed version with minimal changes to address the vulnerability"
  },
  "version_b": {
    "id": "df_b_tc_018",
    "file": "../../base/contracts/tc_018.sol",
    "is_vulnerable": true,
    "status": "vulnerable",
    "description": "Original vulnerable version (in data/base/contracts/)"
  },
  "ground_truth": {
    "vulnerability_type": "price_manipulation",
    "severity": "high",
    "vulnerable_location": {
      "contract_name": {
        "name": "IndexPool",
        "functions": [
          {
            "name": "_updateWeights",
            "vulnerability": "Updates token weights based on instantaneous balances, allowing flash loan manipulation"
          },
          {
            "name": "swap",
            "vulnerability": "Calls _updateWeights() after each swap, enabling within-transaction price manipulation"
          }
        ]
      },
      "function_name": null,
      "line_numbers": []
    },
    "root_cause": "Token weights in index pools were recalculated based on instantaneous token balances after swaps. Flash loan attackers could temporarily drain liquidity of a single token, causing weight recalculation to heavily undervalue that token, then buy it back at manipulated prices.",
    "attack_vector": "1) Flash loan large amounts of SUSHI, UNI, and other index tokens. 2) Execute massive swaps to drain almost all of a target token (DEFI5) from the pool. 3) Pool's _updateWeights() function recalculates weights based on the new unbalanced state. 4) Target token now has extremely low weight (~1%), making it undervalued. 5) Buy back the drained token at manipulated low prices. 6) Repay flash loans and profit from price discrepancy. Loss: $16M.",
    "impact": "Funds lost: $16,000,000",
    "correct_fix": null
  },
  "differential_details": {
    "difference_type": "minimal_fix",
    "diff_lines": 19,
    "diff_summary": "Minimal fix with 19 lines changed",
    "raw_diff": "20a21,24\n>     mapping(address => uint256) public lastBalance;\n>     mapping(address => uint256) public lastUpdate;\n>     uint256 public constant WEIGHT_UPDATE_INTERVAL = 1 hours;\n> \n27a32,33\n>         lastBalance[token] = 0;\n>         lastUpdate[token] = block.timestamp;\n50,51d55\n<         _updateWeights();\n< \n73c77,79\n<     function _updateWeights() internal {\n---\n>     function updateWeights() external {\n>         require(block.timestamp - lastUpdate[msg.sender] >= WEIGHT_UPDATE_INTERVAL, \"Wait for update interval\");\n> \n78c84\n<             totalValue += tokens[token].balance;\n---\n>             totalValue += (tokens[token].balance + lastBalance[token]) / 2;\n83c89,91\n<             tokens[token].weight = (tokens[token].balance * 100) / totalValue;\n---\n>             tokens[token].weight = ((tokens[token].balance + lastBalance[token]) / 2 * 100) / totalValue;\n>             lastBalance[token] = tokens[token].balance;\n>             lastUpdate[token] = block.timestamp;\n95d102\n<         _updateWeights();\n"
  },
  "provenance": {
    "source": "rekt_news",
    "original_exploit": "Indexed Finance Pool Manipulation",
    "exploit_date": "2021-10-14",
    "protocol_name": "Indexed Finance Pool Manipulation",
    "chain": "ethereum",
    "funds_lost_usd": 16000000
  },
  "tags": [
    "differential",
    "minimal_fix",
    "temporal_contamination",
    "price_manipulation"
  ],
  "quality_metrics": {
    "diff_lines": 19,
    "is_minimal": false,
    "solidity_version_match": true
  }
}