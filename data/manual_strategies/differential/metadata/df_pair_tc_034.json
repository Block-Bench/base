{
  "pair_id": "df_pair_tc_034",
  "strategy": "differential",
  "variant": "minimal",
  "original_id": "tc_034",
  "original_subset": "temporal_contamination",
  "version_a": {
    "id": "df_a_tc_034",
    "file": "contracts/df_a_tc_034.sol",
    "is_vulnerable": false,
    "status": "safe",
    "description": "Fixed version with price deviation check to prevent flash loan share manipulation"
  },
  "version_b": {
    "id": "df_b_tc_034",
    "file": "../../base/contracts/tc_034.sol",
    "is_vulnerable": true,
    "status": "vulnerable",
    "description": "Original vulnerable version (in data/base/contracts/)"
  },
  "ground_truth": {
    "vulnerability_type": "price_manipulation",
    "severity": "high",
    "vulnerable_location": {
      "contract_name": "GammaHypervisor",
      "function_name": "deposit, withdraw",
      "affected_lines_b": [52, 78]
    },
    "root_cause": "Share calculation based on current token balances without protection against flash loan manipulation. Attacker can manipulate total values to mint excess shares or withdraw more than deposited.",
    "attack_vector": "Flash loan to manipulate underlying token balances, deposit at inflated share price or withdraw at deflated price, extract value difference.",
    "impact": "Funds lost: $6,100,000"
  },
  "differential_details": {
    "difference_type": "price_deviation_protection",
    "changes_description_a": "Added lastTotalValue and lastUpdateBlock state variables, MAX_DEVIATION constant (5%), _checkPriceDeviation() function called in deposit and withdraw to reject rapid value changes.",
    "changes_description_b": "No price protection, share values calculated directly from current balances.",
    "exact_changes": [
      {
        "location": "state variables (lines 48-50)",
        "version_a": "uint256 public lastTotalValue;\nuint256 public lastUpdateBlock;\nuint256 constant MAX_DEVIATION = 5;",
        "version_b": "// No price tracking"
      },
      {
        "location": "deposit function (line 59)",
        "version_a": "_checkPriceDeviation(total0, total1);",
        "version_b": "// No price check"
      },
      {
        "location": "_checkPriceDeviation function (lines 77-90)",
        "version_a": "require(currentValue >= minAllowed && currentValue <= maxAllowed, \"Price deviation\");",
        "version_b": "// Function does not exist"
      }
    ],
    "why_this_matters": "The price deviation check prevents flash loan attacks by rejecting transactions when underlying values change more than 5% from stored baseline."
  },
  "provenance": {
    "source": "rekt_news",
    "original_exploit": "Gamma Strategies",
    "exploit_date": "2024-01-01",
    "protocol_name": "Gamma Strategies",
    "chain": "arbitrum",
    "funds_lost_usd": 6100000,
    "transformation_date": "2025-12-29"
  },
  "tags": ["liquidity_vault", "flash_loan", "price_manipulation", "uniswap_v3", "differential", "minimal_fix", "temporal_contamination"]
}
