schema_version: "1.0"
sample_id: "ms_tc_006"
vulnerability_type: "access_control"
vulnerable_lines: [168, 169, 170]

# Full line coverage for scoring. UNRELATED items are batched for efficiency.
# Detailed rationales only for security-relevant code acts.

code_acts:

  # ============================================
  # SECURITY-RELEVANT CODE ACTS (detailed)
  # ============================================

  - id: "CA1"
    type: "DECLARATION"
    lines: [9]
    code: "uint256 public requiredSignatures = 5; // Need 5 out of 9"
    security_function: "BENIGN"
    rationale: "Validator threshold configuration. This is a reasonable governance parameter (5/9 majority). The original Ronin exploit was an off-chain key compromise, not a code bug. This sample focuses on the actual code vulnerability in addSupportedToken."

  - id: "CA2"
    type: "DECLARATION"
    lines: [6, 7]
    code: |
      address[] public validators;
      mapping(address => bool) public isValidator;
    security_function: "BENIGN"
    rationale: "Validator storage declarations. Correctly implemented."

  - id: "CA3"
    type: "DECLARATION"
    lines: [10]
    code: "uint256 public validatorCount;"
    security_function: "BENIGN"
    rationale: "Validator count storage. Correctly implemented."

  - id: "CA4"
    type: "DECLARATION"
    lines: [13]
    code: "mapping(uint256 => bool) public processedWithdrawals;"
    security_function: "BENIGN"
    rationale: "Replay protection mapping. Correctly implemented."

  - id: "CA5"
    type: "DECLARATION"
    lines: [16]
    code: "mapping(address => bool) public supportedTokens;"
    security_function: "BENIGN"
    rationale: "Supported tokens mapping. Correctly implemented."

  - id: "CA6"
    type: "INITIALIZATION"
    lines: [25, 26, 27, 28, 29, 31, 32, 33, 34, 36, 37, 38, 40, 41]
    code: "constructor with validator initialization"
    security_function: "BENIGN"
    rationale: "Constructor correctly validates and registers validators. Checks for minimum count, zero addresses, and duplicates."

  - id: "CA7"
    type: "INPUT_VAL"
    lines: [51]
    code: 'require(!processedWithdrawals[_withdrawalId], "Already processed");'
    security_function: "BENIGN"
    rationale: "Replay protection check. Correctly prevents double-processing of withdrawals."

  - id: "CA8"
    type: "INPUT_VAL"
    lines: [54]
    code: 'require(supportedTokens[_token], "Token not supported");'
    security_function: "BENIGN"
    rationale: "Token whitelist check. Correctly implemented."

  - id: "CA9"
    type: "EXT_CALL"
    lines: [57, 58, 59, 60, 61, 62, 63, 64, 65, 66]
    code: "require(_verifySignatures(...), 'Invalid signatures');"
    security_function: "BENIGN"
    rationale: "Signature verification call. Correctly implemented cryptographic verification."

  - id: "CA10"
    type: "STATE_MOD"
    lines: [69]
    code: "processedWithdrawals[_withdrawalId] = true;"
    security_function: "BENIGN"
    rationale: "Marks withdrawal as processed. Correctly prevents replay."

  - id: "CA11"
    type: "EVENT_EMIT"
    lines: [75]
    code: "emit WithdrawalProcessed(_withdrawalId, _user, _token, _amount);"
    security_function: "BENIGN"
    rationale: "Event emission for logging. Correctly implemented."

  - id: "CA12"
    type: "INPUT_VAL"
    lines: [85, 87, 88]
    code: |
      require(_signatures.length % 65 == 0, "Invalid signature length");
      uint256 signatureCount = _signatures.length / 65;
      require(signatureCount >= requiredSignatures, "Not enough signatures");
    security_function: "BENIGN"
    rationale: "Signature count validation. Correctly validates signature format and minimum count threshold."

  - id: "CA13"
    type: "COMPUTATION"
    lines: [91, 92, 93, 94, 95, 96]
    code: "messageHash = keccak256(...); ethSignedMessageHash = keccak256(...);"
    security_function: "BENIGN"
    rationale: "Message hash reconstruction for signature verification. Cryptographically correct."

  - id: "CA14"
    type: "CTRL_FLOW"
    lines: [101, 102, 103, 106, 109, 110, 111, 113, 114]
    code: "for loop verifying each signature"
    security_function: "BENIGN"
    rationale: "Signature verification loop. Correctly verifies each signature against validator set and checks for duplicates."

  - id: "CA15"
    type: "CTRL_FLOW"
    lines: [117]
    code: "return true;"
    security_function: "BENIGN"
    rationale: "Return after all checks pass."

  - id: "CA16"
    type: "COMPUTATION"
    lines: [123, 124, 125, 126, 127, 128, 130, 131, 132, 134]
    code: "_extractSignature function"
    security_function: "BENIGN"
    rationale: "Utility function to extract individual signature from concatenated bytes. Correctly implemented."

  - id: "CA17"
    type: "COMPUTATION"
    lines: [140, 141, 142, 143, 144, 146, 147, 148, 150, 151, 152, 153, 154, 156, 157, 158, 160, 162]
    code: "_recoverSigner function using ecrecover"
    security_function: "BENIGN"
    rationale: "Standard ECDSA signature recovery. Correctly implemented with proper v value handling."

  - id: "CA18"
    type: "ACCESS_CTRL"
    lines: [168, 169, 170]
    code: |
      function addSupportedToken(address _token) external {
          supportedTokens[_token] = true;
      }
    security_function: "ROOT_CAUSE"
    rationale: "Missing access control on admin function. Anyone can call addSupportedToken to add arbitrary tokens to the whitelist, bypassing the intended token governance. This is the actual code vulnerability in this sample."

  # ============================================
  # UNRELATED CODE ACTS (batched)
  # ============================================

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma statements"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: [5, 12, 15, 50, 53, 56, 68, 71, 72, 73, 90, 100, 105, 108, 116, 120, 121, 122, 137, 138, 139, 165, 166, 167]
    security_function: "UNRELATED"
    rationale: "Inline comments and NatSpec documentation"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [4, 43, 44, 45, 46, 47, 48, 49, 78, 79, 80, 81, 82, 83, 84, 98, 171]
    security_function: "UNRELATED"
    rationale: "Contract, function signature, and local variable declarations"

  - id: "CA_SYNTAX"
    type: "SYNTAX"
    lines: [76, 118, 135, 163]
    security_function: "UNRELATED"
    rationale: "Closing braces and structural tokens"

  - id: "CA_EVENT_DEFS"
    type: "EVENT_DEF"
    lines: [18, 19, 20, 21, 22, 23]
    security_function: "UNRELATED"
    rationale: "Event declarations"

summary:
  total_code_acts: 23
  total_lines_covered: 137  # excludes empty lines

  by_security_function:
    ROOT_CAUSE: 1      # CA18
    PREREQ: 0
    BENIGN: 17         # CA1-CA17
    UNRELATED: 5       # batched

  root_causes:
    - id: "CA18"
      lines: [168, 169, 170]
      type: "ACCESS_CTRL"
      description: "addSupportedToken has no access control - anyone can add tokens"

  prerequisites: []

line_to_code_act:
    1: "CA_DIRECTIVES"
    2: "CA_DIRECTIVES"
    # Line 3: empty
    4: "CA_DECLARATIONS"
    5: "CA_COMMENTS"
    6: "CA2"
    7: "CA2"
    # Line 8: empty
    9: "CA1"
    10: "CA3"
    # Line 11: empty
    12: "CA_COMMENTS"
    13: "CA4"
    # Line 14: empty
    15: "CA_COMMENTS"
    16: "CA5"
    # Line 17: empty
    18: "CA_EVENT_DEFS"
    19: "CA_EVENT_DEFS"
    20: "CA_EVENT_DEFS"
    21: "CA_EVENT_DEFS"
    22: "CA_EVENT_DEFS"
    23: "CA_EVENT_DEFS"
    # Line 24: empty
    25: "CA6"
    26: "CA6"
    27: "CA6"
    28: "CA6"
    29: "CA6"
    # Line 30: empty
    31: "CA6"
    32: "CA6"
    33: "CA6"
    34: "CA6"
    # Line 35: empty
    36: "CA6"
    37: "CA6"
    38: "CA6"
    # Line 39: empty
    40: "CA6"
    41: "CA6"
    # Line 42: empty
    43: "CA_DECLARATIONS"
    44: "CA_DECLARATIONS"
    45: "CA_DECLARATIONS"
    46: "CA_DECLARATIONS"
    47: "CA_DECLARATIONS"
    48: "CA_DECLARATIONS"
    49: "CA_DECLARATIONS"
    50: "CA_COMMENTS"
    51: "CA7"
    # Line 52: empty
    53: "CA_COMMENTS"
    54: "CA8"
    # Line 55: empty
    56: "CA_COMMENTS"
    57: "CA9"
    58: "CA9"
    59: "CA9"
    60: "CA9"
    61: "CA9"
    62: "CA9"
    63: "CA9"
    64: "CA9"
    65: "CA9"
    66: "CA9"
    # Line 67: empty
    68: "CA_COMMENTS"
    69: "CA10"
    # Line 70: empty
    71: "CA_COMMENTS"
    72: "CA_COMMENTS"
    73: "CA_COMMENTS"
    # Line 74: empty
    75: "CA11"
    76: "CA_SYNTAX"
    # Line 77: empty
    78: "CA_DECLARATIONS"
    79: "CA_DECLARATIONS"
    80: "CA_DECLARATIONS"
    81: "CA_DECLARATIONS"
    82: "CA_DECLARATIONS"
    83: "CA_DECLARATIONS"
    84: "CA_DECLARATIONS"
    85: "CA12"
    # Line 86: empty
    87: "CA12"
    88: "CA12"
    # Line 89: empty
    90: "CA_COMMENTS"
    91: "CA13"
    92: "CA13"
    93: "CA13"
    94: "CA13"
    95: "CA13"
    96: "CA13"
    # Line 97: empty
    98: "CA_DECLARATIONS"
    # Line 99: empty
    100: "CA_COMMENTS"
    101: "CA14"
    102: "CA14"
    103: "CA14"
    # Line 104: empty
    105: "CA_COMMENTS"
    106: "CA14"
    # Line 107: empty
    108: "CA_COMMENTS"
    109: "CA14"
    110: "CA14"
    111: "CA14"
    # Line 112: empty
    113: "CA14"
    114: "CA14"
    # Line 115: empty
    116: "CA_COMMENTS"
    117: "CA15"
    118: "CA_SYNTAX"
    # Line 119: empty
    120: "CA_COMMENTS"
    121: "CA_COMMENTS"
    122: "CA_COMMENTS"
    123: "CA16"
    124: "CA16"
    125: "CA16"
    126: "CA16"
    127: "CA16"
    128: "CA16"
    # Line 129: empty
    130: "CA16"
    131: "CA16"
    132: "CA16"
    # Line 133: empty
    134: "CA16"
    135: "CA_SYNTAX"
    # Line 136: empty
    137: "CA_COMMENTS"
    138: "CA_COMMENTS"
    139: "CA_COMMENTS"
    140: "CA17"
    141: "CA17"
    142: "CA17"
    143: "CA17"
    144: "CA17"
    # Line 145: empty
    146: "CA17"
    147: "CA17"
    148: "CA17"
    # Line 149: empty
    150: "CA17"
    151: "CA17"
    152: "CA17"
    153: "CA17"
    154: "CA17"
    # Line 155: empty
    156: "CA17"
    157: "CA17"
    158: "CA17"
    # Line 159: empty
    160: "CA17"
    # Line 161: empty
    162: "CA17"
    163: "CA_SYNTAX"
    # Line 164: empty
    165: "CA_COMMENTS"
    166: "CA_COMMENTS"
    167: "CA_COMMENTS"
    168: "CA18"
    169: "CA18"
    170: "CA18"
    171: "CA_DECLARATIONS"
    # Line 172: empty

code_act_security_functions:
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "BENIGN"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA10: "BENIGN"
  CA11: "BENIGN"
  CA12: "BENIGN"
  CA13: "BENIGN"
  CA14: "BENIGN"
  CA15: "BENIGN"
  CA16: "BENIGN"
  CA17: "BENIGN"
  CA18: "ROOT_CAUSE"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"
  CA_SYNTAX: "UNRELATED"
  CA_EVENT_DEFS: "UNRELATED"
