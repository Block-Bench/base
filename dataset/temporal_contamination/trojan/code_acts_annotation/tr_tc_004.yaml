schema_version: "1.0"
sample_id: "tr_tc_004"
base_sample_id: "ms_tc_004"
vulnerability_type: "price_oracle_manipulation"
vulnerability_subtype: "flash_loan_amm_manipulation"
is_vulnerable: true

# Trojan annotation documents INJECTED DECOY elements only.
# The base vulnerability is documented in ms_tc_004.yaml.
# DECOYs are suspicious-looking code that is actually safe - tests pattern matching vs understanding.

trojan_strategy: "pricing_mode_and_analytics_distractors"
injection_count: 5

base_vulnerability:
  type: "price_oracle_manipulation"
  function: "deposit/withdraw"
  vulnerable_lines: [59, 64, 86, 87]  # Line numbers in tr_tc_004.sol
  reference: "../minimalsanitized/code_acts_annotation/ms_tc_004.yaml"

injections:

  # ============================================
  # DECOY 1: pricingMode logic in getTotalAssets
  # ============================================

  - id: "INJ1"
    type: "COMPUTATION"
    security_function: "DECOY"

    location:
      file: "tr_tc_004.sol"
      function: "getTotalAssets"
      lines: [107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117]
    code: |
      if (pricingMode == 0) {
          return poolBalance;
      } else if (pricingMode == 1) {
          return vaultBalance + poolBalance;
      } else {
          uint256 adjusted = poolBalance;
          if (adjusted > 0 && adjusted < 1e6) {
              adjusted = adjusted + 1e6;
          }
          return vaultBalance + adjusted;
      }

    suspicious_because:
      - "Complex pricing mode switch affects asset calculation"
      - "Mode can be changed externally (updatePricingMode has no access control)"
      - "Different modes return different values"
      - "Adjustment logic for small amounts looks suspicious"

    safe_because:
      - "All modes return consistent values based on investedBalance"
      - "pricingMode doesn't enable flash loan manipulation"
      - "The real vulnerability is the lack of price deviation check, not pricingMode"
      - "Changing pricingMode doesn't affect the flash loan attack vector"
      - "Even if attacker sets mode, they still need TWAP protection (which is missing)"

    safety_factors:
      - "Doesn't affect the root cause (spot price manipulation)"
      - "All modes read the same investedBalance"
      - "No additional attack surface created"

    pattern_triggered: "pricing_logic_complexity"
    proximity: "same_file"
    distraction_risk: "high"

  # ============================================
  # DECOY 2: updatePricingMode with no access control
  # ============================================

  - id: "INJ2"
    type: "ACCESS_CTRL"
    security_function: "DECOY"

    location:
      file: "tr_tc_004.sol"
      function: "updatePricingMode"
      lines: [148, 149, 150, 151]
    code: |
      function updatePricingMode(uint256 mode) external {
          pricingMode = mode;
          emit PricingParametersUpdated(mode, block.number);
      }

    suspicious_because:
      - "No access control - anyone can call"
      - "Modifies pricingMode which affects getTotalAssets"
      - "Could potentially affect share/price calculations"
      - "Located in vault contract handling user funds"

    safe_because:
      - "pricingMode changes don't enable the flash loan attack"
      - "The real vulnerability requires no pricingMode manipulation"
      - "Changing pricingMode doesn't bypass any security checks"
      - "The root cause is missing TWAP/deviation protection, not pricingMode"

    safety_factors:
      - "Not part of attack chain"
      - "Doesn't affect flash loan manipulation vector"
      - "All pricingMode values still vulnerable to the same attack"

    pattern_triggered: "missing_access_control"
    proximity: "same_file"
    distraction_risk: "high"

  # ============================================
  # DECOY 3: previewSwap with external call
  # ============================================

  - id: "INJ3"
    type: "EXT_CALL"
    security_function: "DECOY"

    location:
      file: "tr_tc_004.sol"
      function: "previewSwap"
      lines: [155, 156, 157, 158, 159, 160, 161]
    code: |
      function previewSwap(
          int128 i,
          int128 j,
          uint256 dx
      ) external view returns (uint256) {
          return stablePool.get_dy_underlying(i, j, dx);
      }

    suspicious_because:
      - "Makes external call to stablePool"
      - "Calls get_dy_underlying which could be related to price"
      - "No access control - anyone can call"
      - "Similar naming to swap functions that could affect price"

    safe_because:
      - "Function is marked 'view' - read-only"
      - "get_dy_underlying is a view function (price preview)"
      - "Cannot modify state or transfer funds"
      - "Pure utility for off-chain swap simulation"
      - "Not used in deposit/withdraw calculations"

    safety_factors:
      - "View modifier enforces read-only"
      - "External call is to a view function"
      - "No state modification possible"

    pattern_triggered: "external_call_pattern"
    proximity: "same_file"
    distraction_risk: "medium"

  # ============================================
  # DECOY 4: _recordActivity with state modification
  # ============================================

  - id: "INJ4"
    type: "STATE_MOD"
    security_function: "DECOY"

    location:
      file: "tr_tc_004.sol"
      function: "_recordActivity"
      lines: [165, 166, 168, 169, 170, 171, 172, 173, 174, 175, 177, 178, 179]
    code: |
      function _recordActivity(address user, uint256 value) internal {
          uint256 score = userActivityScore[user];
          if (value > 0) {
              uint256 increment = value;
              if (increment > 1e24) {
                  increment = 1e24;
              }
              score += increment;
              aggregateSlippageScore = _updateAggregateScore(aggregateSlippageScore, increment);
          }
          userActivityScore[user] = score;
          emit ActivityRecorded(user, value);
      }

    suspicious_because:
      - "Called after deposit/withdraw state changes"
      - "Modifies multiple state variables"
      - "Has 'slippage' in variable name (aggregateSlippageScore)"
      - "Could potentially be related to price calculations"

    safe_because:
      - "Internal function - not directly callable"
      - "Only tracks analytics - no security impact"
      - "aggregateSlippageScore is just a misleading name"
      - "Not used in share/amount calculations"
      - "Doesn't affect the actual vulnerability"

    safety_factors:
      - "Internal function"
      - "Analytics-only state"
      - "Not used in critical calculations"

    pattern_triggered: "state_modification_pattern"
    proximity: "different_function"
    distraction_risk: "medium"

  # ============================================
  # DECOY 5: _updateAggregateScore with arithmetic
  # ============================================

  - id: "INJ5"
    type: "ARITHMETIC"
    security_function: "DECOY"

    location:
      file: "tr_tc_004.sol"
      function: "_updateAggregateScore"
      lines: [181, 182, 184, 185, 186, 187, 188, 189, 190, 192, 193, 194, 196, 197]
    code: |
      function _updateAggregateScore(uint256 current, uint256 value) internal pure returns (uint256) {
          uint256 updated = current;
          if (value > 0) {
              if (updated == 0) {
                  updated = value;
              } else {
                  updated = (updated + value) / 2;
              }
          }
          if (updated > 1e27) {
              updated = 1e27;
          }
          return updated;
      }

    suspicious_because:
      - "Complex arithmetic with division"
      - "Called during deposit/withdraw flow"
      - "Could affect some score calculation"
      - "Division operation present"

    safe_because:
      - "Internal pure function - no state access"
      - "Only calculates analytics scores"
      - "Result not used in security decisions"
      - "Division by constant (2) is always safe"
      - "Bounded output (1e27 cap)"

    safety_factors:
      - "Pure function"
      - "Analytics only"
      - "Safe division by constant"
      - "Bounded output"

    pattern_triggered: "arithmetic_complexity"
    proximity: "different_function"
    distraction_risk: "low"

# ============================================
# BASE VULNERABILITY CODE ACTS (reference only)
# ============================================
# The real vulnerability in tr_tc_004 is the same as ms_tc_004:
# - CA1: Spot price retrieval in deposit (line 59) - manipulable
# - CA2: Share calculation using manipulable price (line 64)
# - CA3: Spot price retrieval in withdraw (line 86) - manipulable
# - CA4: Amount calculation using manipulable price (line 87)
#
# See ms_tc_004.yaml for full vulnerability annotation.

summary:
  total_injections: 5

  injection_types:
    COMPUTATION: 1   # INJ1 (pricingMode logic)
    ACCESS_CTRL: 1   # INJ2 (updatePricingMode)
    EXT_CALL: 1      # INJ3 (previewSwap)
    STATE_MOD: 1     # INJ4 (_recordActivity)
    ARITHMETIC: 1    # INJ5 (_updateAggregateScore)

  distraction_risk_breakdown:
    high: 2     # INJ1 (pricingMode), INJ2 (updatePricingMode)
    medium: 2   # INJ3 (previewSwap), INJ4 (_recordActivity)
    low: 1      # INJ5 (_updateAggregateScore)

  proximity_breakdown:
    same_file: 3           # INJ1, INJ2, INJ3
    different_function: 2  # INJ4, INJ5

  patterns_triggered:
    pricing_logic_complexity: 1     # INJ1
    missing_access_control: 1       # INJ2
    external_call_pattern: 1        # INJ3
    state_modification_pattern: 1   # INJ4
    arithmetic_complexity: 1        # INJ5

  evaluation_notes:
    - "INJ1 (pricingMode) is highly deceptive: complex pricing logic that looks exploitable but doesn't affect flash loan attack"
    - "INJ2 (updatePricingMode) has no access control but changing mode doesn't enable the attack"
    - "INJ3 (previewSwap) makes external call but is a view function"
    - "INJ4 (_recordActivity) modifies state but only for analytics"
    - "INJ5 (_updateAggregateScore) has arithmetic but is pure analytics calculation"
    - "A model that flags INJ1/INJ2 demonstrates pattern matching over understanding"
    - "The real vulnerability requires understanding that TWAP/deviation check is missing"

# ============================================
# LINE TO CODE ACT MAPPINGS (for scoring)
# ============================================
# Maps line numbers in tr_tc_004.sol to code acts.
# Includes both real vulnerability code acts AND injected DECOYs.

line_to_code_act:
  # === UNRELATED: Directives ===
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  # Line 3: empty
  # === UNRELATED: Comments (NatSpec) ===
  4: "CA_COMMENTS"
  5: "CA_COMMENTS"
  6: "CA_COMMENTS"
  7: "CA_COMMENTS"
  8: "CA_COMMENTS"
  # Line 9: empty
  # === UNRELATED: Interface declarations ===
  10: "CA_DECLARATIONS"
  11: "CA_DECLARATIONS"
  12: "CA_DECLARATIONS"
  13: "CA_DECLARATIONS"
  14: "CA_DECLARATIONS"
  15: "CA_DECLARATIONS"
  16: "CA_DECLARATIONS"
  # Line 17: empty
  18: "CA_DECLARATIONS"
  19: "CA_DECLARATIONS"
  20: "CA_DECLARATIONS"
  21: "CA_DECLARATIONS"
  22: "CA_DECLARATIONS"
  23: "CA_DECLARATIONS"
  # Line 24: empty
  # === UNRELATED: Contract declarations ===
  25: "CA_DECLARATIONS"
  26: "CA_DECLARATIONS"
  27: "CA_DECLARATIONS"
  # Line 28: empty
  29: "CA_DECLARATIONS"
  30: "CA_DECLARATIONS"
  # Line 31: empty
  32: "CA_DECLARATIONS"
  # Line 33: empty
  # === DECOY: Distractor state variables ===
  34: "CA_DECOY_VARS"
  35: "CA_DECOY_VARS"
  36: "CA_DECOY_VARS"
  37: "CA_DECOY_VARS"
  38: "CA_DECOY_VARS"
  # Line 39: empty
  40: "CA_DECLARATIONS"
  41: "CA_DECLARATIONS"
  42: "CA_DECLARATIONS"
  43: "CA_DECLARATIONS"
  # Line 44: empty
  # === Constructor ===
  45: "CA_DECLARATIONS"
  46: "CA_DECLARATIONS"
  47: "CA_DECLARATIONS"
  48: "CA_DECLARATIONS"
  49: "CA_SYNTAX"
  # Line 50: empty
  # === deposit() NatSpec ===
  51: "CA_COMMENTS"
  52: "CA_COMMENTS"
  53: "CA_COMMENTS"
  54: "CA_COMMENTS"
  55: "CA_COMMENTS"
  # === deposit() function ===
  56: "CA_DECLARATIONS"
  57: "CA5"
  # Line 58: empty
  # === ROOT_CAUSE: Spot price in deposit ===
  59: "CA1"
  # Line 60: empty
  61: "CA6"
  62: "CA6"
  63: "CA6"
  # === ROOT_CAUSE: Share calculation ===
  64: "CA2"
  65: "CA_SYNTAX"
  # Line 66: empty
  67: "CA7"
  68: "CA8"
  # Line 69: empty
  70: "CA9"
  71: "CA_DECOY_CALL"
  # Line 72: empty
  73: "CA10"
  74: "CA_SYNTAX"
  75: "CA_SYNTAX"
  # Line 76: empty
  # === withdraw() NatSpec ===
  77: "CA_COMMENTS"
  78: "CA_COMMENTS"
  79: "CA_COMMENTS"
  80: "CA_COMMENTS"
  81: "CA_COMMENTS"
  # === withdraw() function ===
  82: "CA_DECLARATIONS"
  83: "CA11"
  84: "CA12"
  # Line 85: empty
  # === ROOT_CAUSE: Spot price in withdraw ===
  86: "CA3"
  # === ROOT_CAUSE: Amount calculation ===
  87: "CA4"
  # Line 88: empty
  89: "CA13"
  90: "CA14"
  # Line 91: empty
  92: "CA15"
  93: "CA_DECOY_CALL"
  # Line 94: empty
  95: "CA16"
  96: "CA_SYNTAX"
  97: "CA_SYNTAX"
  # Line 98: empty
  # === getTotalAssets() NatSpec ===
  99: "CA_COMMENTS"
  100: "CA_COMMENTS"
  101: "CA_COMMENTS"
  102: "CA_COMMENTS"
  # === getTotalAssets() function ===
  103: "CA_DECLARATIONS"
  104: "CA17"
  105: "CA17"
  # Line 106: empty
  # === DECOY INJ1: pricingMode logic ===
  107: "INJ1"
  108: "INJ1"
  109: "INJ1"
  110: "INJ1"
  111: "INJ1"
  112: "INJ1"
  113: "INJ1"
  114: "INJ1"
  115: "INJ1"
  116: "INJ1"
  117: "INJ1"
  118: "CA_SYNTAX"
  # Line 119: empty
  # === getPricePerFullShare() NatSpec ===
  120: "CA_COMMENTS"
  121: "CA_COMMENTS"
  122: "CA_COMMENTS"
  123: "CA_COMMENTS"
  # === getPricePerFullShare() function ===
  124: "CA_DECLARATIONS"
  125: "CA18"
  126: "CA18"
  127: "CA_SYNTAX"
  # Line 128: empty
  # === _investInPool() NatSpec ===
  129: "CA_COMMENTS"
  130: "CA_COMMENTS"
  131: "CA_COMMENTS"
  # === _investInPool() function ===
  132: "CA_DECLARATIONS"
  133: "CA19"
  134: "CA_DECOY_VARS"
  135: "CA_SYNTAX"
  # Line 136: empty
  # === _withdrawFromPool() NatSpec ===
  137: "CA_COMMENTS"
  138: "CA_COMMENTS"
  139: "CA_COMMENTS"
  # === _withdrawFromPool() function ===
  140: "CA_DECLARATIONS"
  141: "CA20"
  142: "CA21"
  143: "CA_DECOY_VARS"
  144: "CA_SYNTAX"
  # Line 145: empty
  146: "CA_COMMENTS"
  # Line 147: empty
  # === DECOY INJ2: updatePricingMode ===
  148: "INJ2"
  149: "INJ2"
  150: "INJ2"
  151: "INJ2"
  # Line 152: empty
  153: "CA_COMMENTS"
  # Line 154: empty
  # === DECOY INJ3: previewSwap ===
  155: "INJ3"
  156: "INJ3"
  157: "INJ3"
  158: "INJ3"
  159: "INJ3"
  160: "INJ3"
  161: "INJ3"
  # Line 162: empty
  163: "CA_COMMENTS"
  # Line 164: empty
  # === DECOY INJ4: _recordActivity ===
  165: "INJ4"
  166: "INJ4"
  # Line 167: empty
  168: "INJ4"
  169: "INJ4"
  170: "INJ4"
  171: "INJ4"
  172: "INJ4"
  173: "INJ4"
  174: "INJ4"
  175: "INJ4"
  # Line 176: empty
  177: "INJ4"
  178: "INJ4"
  179: "INJ4"
  # Line 180: empty
  # === DECOY INJ5: _updateAggregateScore ===
  181: "INJ5"
  182: "INJ5"
  # Line 183: empty
  184: "INJ5"
  185: "INJ5"
  186: "INJ5"
  187: "INJ5"
  188: "INJ5"
  189: "INJ5"
  190: "INJ5"
  # Line 191: empty
  192: "INJ5"
  193: "INJ5"
  194: "INJ5"
  # Line 195: empty
  196: "INJ5"
  197: "INJ5"
  # Line 198: empty
  199: "CA_COMMENTS"
  # Line 200: empty
  # === View helpers ===
  201: "CA_DECLARATIONS"
  202: "CA_BENIGN"
  203: "CA_BENIGN"
  204: "CA_SYNTAX"
  # Line 205: empty
  206: "CA_DECLARATIONS"
  207: "CA_BENIGN"
  208: "CA_BENIGN"
  209: "CA_BENIGN"
  210: "CA_BENIGN"
  211: "CA_SYNTAX"
  212: "CA_SYNTAX"

code_act_security_functions:
  # Real vulnerability code acts (from base ms_tc_004)
  CA1: "ROOT_CAUSE"
  CA2: "ROOT_CAUSE"
  CA3: "ROOT_CAUSE"
  CA4: "ROOT_CAUSE"
  CA5: "BENIGN"
  CA6: "BENIGN"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA10: "BENIGN"
  CA11: "BENIGN"
  CA12: "BENIGN"
  CA13: "BENIGN"
  CA14: "BENIGN"
  CA15: "BENIGN"
  CA16: "BENIGN"
  CA17: "PREREQ"
  CA18: "PREREQ"
  CA19: "BENIGN"
  CA20: "BENIGN"
  CA21: "BENIGN"
  # Injected decoys
  INJ1: "DECOY"
  INJ2: "DECOY"
  INJ3: "DECOY"
  INJ4: "DECOY"
  INJ5: "DECOY"
  # Supporting decoy elements
  CA_DECOY_VARS: "DECOY"
  CA_DECOY_CALL: "DECOY"
  CA_BENIGN: "BENIGN"
  # Unrelated
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"
  CA_SYNTAX: "UNRELATED"
