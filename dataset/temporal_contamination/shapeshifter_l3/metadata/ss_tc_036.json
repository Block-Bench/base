{
  "sample_id": "ss_tc_036",
  "exploit_name": "Prisma Finance Delegate Approval",
  "timestamp": "2024-03",
  "loss_amount_usd": 10000000,
  "blockchain": "ethereum",
  "vulnerability_type": "access_control",
  "sub_category": "delegate_approval",
  "severity": "critical",
  "tags": [
    "delegate_approval",
    "access_control",
    "migration",
    "zap_contract",
    "authorization_bypass"
  ],
  "difficulty": "advanced",
  "temporal_category": "pre_cutoff",
  "cutoff_date": "2024-03",
  "description": "Prisma Finance suffered a $10M exploit through its MigrateTroveZap contract which accepted user-controlled account parameters. Attackers exploited delegate approvals to open troves and mint debt tokens on behalf of victims who had approved the zap contract, then received the minted tokens themselves.",
  "vulnerable_lines": [],
  "vulnerability_details": {
    "root_cause": "User-controlled account parameter in zap contract combined with overly permissive delegate approval system",
    "attack_vector": "Use delegate approval to open troves on victim accounts with attacker's collateral, mint debt to attacker, victim gets debt obligation",
    "vulnerable_functions": [
      "_0x0cce35()",
      "_0x0f4194()",
      "_0x0353ce()"
    ],
    "key_weakness": [
      "User-controlled account parameter",
      "Overly permissive delegate approvals",
      "No distinction between delegation types",
      "Missing msg.sender validation",
      "No time-bounded approvals",
      "No operation-specific permissions"
    ]
  },
  "attack_flow": [
    "Identify victims who approved MigrateTroveZap as delegate",
    "Obtain flashloan of ~1800 wstETH collateral",
    "Call openTroveAndMigrate() with victim's address as account parameter",
    "Zap contract uses delegate approval to authorize operation",
    "Opens trove using attacker's collateral on victim's account",
    "Mints maximum debt (mkUSD) and sends to attacker",
    "Victim's account now has debt obligation, attacker has debt tokens",
    "Repeat for multiple victims to drain $10M",
    "Close positions and repay flashloan with profits"
  ],
  "mitigation": [
    "Validate account == msg.sender for critical operations",
    "Implement granular permission system for specific operations",
    "Add time-bounded approvals with expiration",
    "Scope delegate permissions to specific operation types",
    "Require explicit confirmation for debt-creating operations",
    "Implement maximum debt limits per delegation",
    "Add circuit breakers for unusual delegation patterns",
    "Revoke and require re-approval of all delegate permissions",
    "Add withdrawal delays after delegation changes"
  ],
  "references": [
    "https://twitter.com/EXVULSEC/status/1773371049951797485",
    "https://twitter.com/PrismaFi/status/1773371030129524957",
    "https://etherscan.io/address/0xcc7218100da61441905e0c327749972e3cbee9ee"
  ],
  "contract_file": "contracts/ss_tc_036.sol",
  "subset": "annotated",
  "original_subset": "temporal_contamination",
  "variant_type": "shapeshifter_l3",
  "variant_parent_id": "nc_tc_036",
  "transformation": {
    "type": "shapeshifter",
    "level": "l3",
    "includes": [
      "L1 formatting",
      "L2 hex identifiers",
      "L3 control flow"
    ],
    "identifier_style": "hex",
    "intensity": "medium",
    "source_dir": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/nocomments",
    "source_contract": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/nocomments/contracts/nc_tc_036.sol",
    "source_metadata": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/nocomments/metadata/nc_tc_036.json",
    "script": "strategies/shapeshifter/shapeshifter_tc.py",
    "changes": [
      "Stripped existing line markers",
      "Renamed 38 identifiers using hex style",
      "Wrapped assignment in conditional",
      "Wrapped assignment in conditional",
      "Applied L1 tight formatting (removed blank lines, K&R braces)",
      "Added fresh sequential line markers"
    ],
    "rename_map": {
      "_borrowerOperations": "_0x390062",
      "openTroveAndMigrate": "_0x0cce35",
      "getTroveCollAndDebt": "_0x8cd0a4",
      "setDelegateApproval": "_0x7d6277",
      "borrowerOperations": "_0x7248ad",
      "_collateralAmount": "_0x477183",
      "_maxFeePercentage": "_0x347a3f",
      "collateralAmount": "_0x2c833f",
      "maxFeePercentage": "_0xd80623",
      "_troveManager": "_0x1045d1",
      "closeTroveFor": "_0x0f4194",
      "transferFrom": "_0x2ff8d2",
      "troveManager": "_0x6ff151",
      "_isApproved": "_0x771f54",
      "_debtAmount": "_0x0d961f",
      "debtAmount": "_0x65ce0c",
      "_lowerHint": "_0xd6cb4d",
      "_upperHint": "_0x70dd97",
      "closeTrove": "_0xe5feba",
      "upperHint": "_0x8e6f03",
      "openTrove": "_0x0353ce",
      "liquidate": "_0x51bedd",
      "_borrower": "_0xd860ea",
      "lowerHint": "_0xae3550",
      "balanceOf": "_0x8e4527",
      "_delegate": "_0x4f9b02",
      "delegates": "_0x6e3d9a",
      "account": "_0xac561e",
      "spender": "_0x3454e7",
      "approve": "_0x2f7c62",
      "_wstETH": "_0xc285d4",
      "amount": "_0x3184cf",
      "_mkUSD": "_0xb7cc25",
      "wstETH": "_0xb01af6",
      "mkUSD": "_0x876f47",
      "debt": "_0x163f22",
      "coll": "_0xeb39bc",
      "to": "_0x3fe936"
    },
    "coverage_percent": 79.17,
    "identifiers_transformed": 38,
    "created_date": "2025-12-30T00:24:49.132072"
  }
}