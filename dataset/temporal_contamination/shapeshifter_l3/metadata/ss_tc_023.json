{
  "id": "alpha_homora_2021_02",
  "exploit_name": "Alpha Homora Credit Account Manipulation",
  "date": "2021-02-13",
  "blockchain": "ethereum",
  "amount_lost_usd": "37000000",
  "vulnerability_type": "accounting_manipulation",
  "difficulty": 5,
  "tags": [
    "leverage",
    "iron_bank",
    "lending_finance",
    "debt_accounting",
    "share_calculation",
    "flash_loan"
  ],
  "description": "Alpha Homora V2 integrated with Cream's Iron Bank for leveraged yield farming. The vulnerability was in how debt shares were calculated when totalDebt could be manipulated through external pool state changes. Attackers borrowed funds and manipulated pool reserves to skew the share-to-amount conversion, allowing them to receive far more value than their debt obligations reflected.",
  "attack_scenario": "1) Attacker opened leveraged position and borrowed initial funds from Iron Bank. 2) Used flash loans to manipulate sUSD/USDC pool reserves. 3) Pool manipulation caused totalDebt calculations to become stale/incorrect. 4) Opened second position with manipulated totalDebt value. 5) Debt share calculation: (borrowAmount * totalDebtShare) / inflatedTotalDebt resulted in fewer shares than deserved. 6) When converting back, attacker's debt appeared much smaller than actual borrowed amount. 7) Repaid calculated debt and withdrew collateral, keeping difference. 8) Repeated to drain $37M.",
  "vulnerable_contract": {
    "name": "LeveragedBank",
    "functions": [
      {
        "name": "_0xe5feba",
        "vulnerability": "Debt share calculation relies on manipulatable totalDebt value"
      },
      {
        "name": "_0x8cd0a4",
        "vulnerability": "Returns debt based on potentially manipulated share ratio"
      }
    ]
  },
  "root_cause": "Debt share calculation depended on totalDebt value that could be manipulated via external pool state changes. The share-to-amount conversion (amount * totalDebtShare / totalDebt) was vulnerable when totalDebt was artificially inflated through pool manipulation, resulting in attackers receiving fewer debt shares than they should for borrowed amounts.",
  "vulnerable_lines": [],
  "fix": "Use manipulation-resistant accounting that doesn't rely on external pool states. Implement debt ceilings per position. Use time-weighted averages for debt calculations. Separate internal debt tracking from external dependencies. Add sanity checks ensuring debt shares properly reflect borrowed amounts.",
  "references": [
    "https://blog.alphaventuredao.io/alpha-homora-v2-post-mortem/",
    "https://twitter.com/AlphaFinanceLab/status/1360505710955597827",
    "https://rekt.news/alpha-finance-rekt/"
  ],
  "temporal_category": "pre_cutoff",
  "variant_type": "shapeshifter_l3",
  "checks_effects_interactions_violated": false,
  "involves_external_calls": true,
  "contract_file": "contracts/ss_tc_023.sol",
  "subset": "annotated",
  "original_subset": "temporal_contamination",
  "sample_id": "ss_tc_023",
  "variant_parent_id": "nc_tc_023",
  "transformation": {
    "type": "shapeshifter",
    "level": "l3",
    "includes": [
      "L1 formatting",
      "L2 hex identifiers",
      "L3 control flow"
    ],
    "identifier_style": "hex",
    "intensity": "medium",
    "source_dir": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/nocomments",
    "source_contract": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/nocomments/contracts/nc_tc_023.sol",
    "source_metadata": "/Users/poamen/projects/grace/blockbench/base/dataset/temporal_contamination/nocomments/metadata/nc_tc_023.json",
    "script": "strategies/shapeshifter/shapeshifter_tc.py",
    "changes": [
      "Stripped existing line markers",
      "Renamed 28 identifiers using hex style",
      "Wrapped assignment in conditional",
      "Wrapped assignment in conditional",
      "Applied L1 tight formatting (removed blank lines, K&R braces)",
      "Added fresh sequential line markers"
    ],
    "rename_map": {
      "borrowBalanceCurrent": "_0x390062",
      "collateralAmount": "_0x0cce35",
      "getPositionDebt": "_0x8cd0a4",
      "nextPositionId": "_0x7d6277",
      "totalDebtShare": "_0x7248ad",
      "shareToRemove": "_0x477183",
      "transferFrom": "_0x347a3f",
      "borrowAmount": "_0x2c833f",
      "openPosition": "_0xd80623",
      "positionId": "_0x1045d1",
      "collateral": "_0x0f4194",
      "positions": "_0x2ff8d2",
      "liquidate": "_0x6ff151",
      "debtShare": "_0x771f54",
      "balanceOf": "_0x0d961f",
      "totalDebt": "_0x65ce0c",
      "_cToken": "_0xd6cb4d",
      "account": "_0x70dd97",
      "_borrow": "_0xe5feba",
      "amount": "_0x8e6f03",
      "cToken": "_0x0353ce",
      "borrow": "_0x51bedd",
      "owner": "_0xd860ea",
      "repay": "_0xae3550",
      "share": "_0x8e4527",
      "debt": "_0x4f9b02",
      "pos": "_0x6e3d9a",
      "to": "_0xac561e"
    },
    "coverage_percent": 73.68,
    "identifiers_transformed": 28,
    "created_date": "2025-12-30T00:24:49.099299"
  }
}