schema_version: "1.0"
sample_id: "df_tc_004"
base_sample_id: "ms_tc_004"
vulnerability_type: "price_oracle_manipulation"
vulnerability_subtype: "flash_loan_amm_manipulation"
is_vulnerable: false

# Differential annotation tracks transitions from vulnerable to fixed version.
# Focus on how the fix changes security functions of code acts.

fix_strategy: "price_deviation_protection"
fix_description: "Added price deviation check with stored price comparison. The _checkPriceDeviation() function rejects transactions when spot price deviates more than 5% from stored price, making flash loan manipulation unprofitable."

base_vulnerability:
  type: "price_oracle_manipulation"
  functions: ["deposit", "withdraw"]
  root_cause_lines_in_base: [50, 51, 69, 70]  # Lines in ms_tc_004
  reference: "../minimalsanitized/code_acts_annotation/ms_tc_004.yaml"

# ============================================
# FIX CODE ACTS (NEW elements that implement the fix)
# ============================================

fix_code_acts:

  - id: "CA_FIX1"
    type: "DECLARATION"
    lines: [36, 37, 38, 39]
    code: |
      uint256 public lastPricePerShare;
      uint256 public lastPriceUpdate;
      uint256 constant MAX_PRICE_DEVIATION = 5;
      uint256 constant MIN_PRICE_UPDATE_INTERVAL = 1 hours;
    security_function: "NEW"
    transition: "NEW_to_BENIGN"
    rationale: "State variables and constants for price deviation protection. Enable tracking of stored price for comparison."

  - id: "CA_FIX2"
    type: "INITIALIZATION"
    lines: [47, 48]
    code: |
      lastPricePerShare = 1e18;
      lastPriceUpdate = block.timestamp;
    security_function: "NEW"
    transition: "NEW_to_BENIGN"
    rationale: "Initialize stored price in constructor to enable deviation checks from first transaction."

  - id: "CA_FIX3"
    type: "INPUT_VAL"
    lines: [58]
    code: "_checkPriceDeviation();"
    security_function: "NEW"
    transition: "NEW_to_BENIGN"
    rationale: "Call price deviation check in deposit() before calculating shares. Blocks flash loan manipulation."

  - id: "CA_FIX4"
    type: "EXT_CALL"
    lines: [73]
    code: "_updatePrice();"
    security_function: "NEW"
    transition: "NEW_to_BENIGN"
    rationale: "Update stored price after deposit. Time-gated to prevent same-block updates."

  - id: "CA_FIX5"
    type: "INPUT_VAL"
    lines: [87]
    code: "_checkPriceDeviation();"
    security_function: "NEW"
    transition: "NEW_to_BENIGN"
    rationale: "Call price deviation check in withdraw() before calculating amount. Blocks flash loan manipulation."

  - id: "CA_FIX6"
    type: "EXT_CALL"
    lines: [98]
    code: "_updatePrice();"
    security_function: "NEW"
    transition: "NEW_to_BENIGN"
    rationale: "Update stored price after withdraw. Time-gated to prevent same-block updates."

  - id: "CA_FIX7"
    type: "INPUT_VAL"
    lines: [107, 108, 109, 110, 111, 112, 113]
    code: |
      function _checkPriceDeviation() internal view {
          if (totalSupply == 0) return;
          uint256 currentPrice = getPricePerFullShare();
          uint256 maxAllowed = lastPricePerShare * (100 + MAX_PRICE_DEVIATION) / 100;
          uint256 minAllowed = lastPricePerShare * (100 - MAX_PRICE_DEVIATION) / 100;
          require(currentPrice >= minAllowed && currentPrice <= maxAllowed, "Price deviation too high");
      }
    security_function: "NEW"
    transition: "NEW_to_BENIGN"
    rationale: "The core fix function. Compares current spot price to stored price and reverts if deviation exceeds 5%. Prevents flash loan manipulation."

  - id: "CA_FIX8"
    type: "STATE_MOD"
    lines: [118, 119, 120, 121, 122, 123]
    code: |
      function _updatePrice() internal {
          if (block.timestamp >= lastPriceUpdate + MIN_PRICE_UPDATE_INTERVAL) {
              lastPricePerShare = getPricePerFullShare();
              lastPriceUpdate = block.timestamp;
          }
      }
    security_function: "NEW"
    transition: "NEW_to_BENIGN"
    rationale: "Updates stored price only after minimum interval (1 hour). Time gate prevents same-transaction manipulation."

# ============================================
# TRANSITIONED CODE ACTS (moved/changed from base)
# ============================================

transitioned_code_acts:

  # The oracle calls and calculations are now protected by the deviation check
  # They transition from ROOT_CAUSE to BENIGN because the fix makes them safe

  - id: "CA1"
    base_id: "CA1"
    type: "ORACLE"
    base_lines: [50]
    new_lines: [64]
    code: "uint256 totalAssets = getTotalAssets();"
    base_security_function: "ROOT_CAUSE"
    new_security_function: "BENIGN"
    transition: "ROOT_CAUSE_to_BENIGN"
    rationale: "Spot price retrieval in deposit now protected by _checkPriceDeviation(). Flash loan manipulation blocked."

  - id: "CA2"
    base_id: "CA2"
    type: "COMPUTATION"
    base_lines: [51]
    new_lines: [65]
    code: "shares = (amount * totalSupply) / totalAssets;"
    base_security_function: "ROOT_CAUSE"
    new_security_function: "BENIGN"
    transition: "ROOT_CAUSE_to_BENIGN"
    rationale: "Share calculation now safe because price deviation check prevents manipulated input."

  - id: "CA3"
    base_id: "CA3"
    type: "ORACLE"
    base_lines: [69]
    new_lines: [90]
    code: "uint256 totalAssets = getTotalAssets();"
    base_security_function: "ROOT_CAUSE"
    new_security_function: "BENIGN"
    transition: "ROOT_CAUSE_to_BENIGN"
    rationale: "Spot price retrieval in withdraw now protected by _checkPriceDeviation()."

  - id: "CA4"
    base_id: "CA4"
    type: "COMPUTATION"
    base_lines: [70]
    new_lines: [91]
    code: "amount = (shares * totalAssets) / totalSupply;"
    base_security_function: "ROOT_CAUSE"
    new_security_function: "BENIGN"
    transition: "ROOT_CAUSE_to_BENIGN"
    rationale: "Amount calculation now safe because price deviation check prevents manipulated input."

  - id: "CA17"
    base_id: "CA17"
    type: "COMPUTATION"
    base_lines: [90, 91, 94]
    new_lines: [130, 131, 133]
    code: "vaultBalance + curveBalance"
    base_security_function: "PREREQ"
    new_security_function: "BENIGN"
    transition: "PREREQ_to_BENIGN"
    rationale: "getTotalAssets() still returns spot value but no longer exploitable due to deviation check."

  - id: "CA18"
    base_id: "CA18"
    type: "COMPUTATION"
    base_lines: [98, 99]
    new_lines: [141, 142]
    code: "(getTotalAssets() * 1e18) / totalSupply"
    base_security_function: "PREREQ"
    new_security_function: "BENIGN"
    transition: "PREREQ_to_BENIGN"
    rationale: "getPricePerFullShare() now part of the fix mechanism, used for deviation comparison."

  # Other code acts that remain BENIGN

  - id: "CA5"
    base_id: "CA5"
    type: "INPUT_VAL"
    base_lines: [38]
    new_lines: [57]
    code: 'require(amount > 0, "Zero amount");'
    base_security_function: "BENIGN"
    new_security_function: "BENIGN"
    transition: "BENIGN_to_BENIGN"

  - id: "CA6"
    base_id: "CA6"
    type: "CTRL_FLOW"
    base_lines: [44, 45, 46]
    new_lines: [61, 62, 63]
    code: "if (totalSupply == 0) { shares = amount; } else {"
    base_security_function: "BENIGN"
    new_security_function: "BENIGN"
    transition: "BENIGN_to_BENIGN"

  - id: "CA7"
    base_id: "CA7"
    type: "STATE_MOD"
    base_lines: [54]
    new_lines: [68]
    code: "balanceOf[msg.sender] += shares;"
    base_security_function: "BENIGN"
    new_security_function: "BENIGN"
    transition: "BENIGN_to_BENIGN"

  - id: "CA8"
    base_id: "CA8"
    type: "STATE_MOD"
    base_lines: [55]
    new_lines: [69]
    code: "totalSupply += shares;"
    base_security_function: "BENIGN"
    new_security_function: "BENIGN"
    transition: "BENIGN_to_BENIGN"

  - id: "CA9"
    base_id: "CA9"
    type: "EXT_CALL"
    base_lines: [58]
    new_lines: [72]
    code: "_investInCurve(amount);"
    base_security_function: "BENIGN"
    new_security_function: "BENIGN"
    transition: "BENIGN_to_BENIGN"

  - id: "CA10"
    base_id: "CA10"
    type: "EVENT_EMIT"
    base_lines: [60]
    new_lines: [75]
    code: "emit Deposit(msg.sender, amount, shares);"
    base_security_function: "BENIGN"
    new_security_function: "BENIGN"
    transition: "BENIGN_to_BENIGN"

  - id: "CA11"
    base_id: "CA11"
    type: "INPUT_VAL"
    base_lines: [65]
    new_lines: [85]
    code: 'require(shares > 0, "Zero shares");'
    base_security_function: "BENIGN"
    new_security_function: "BENIGN"
    transition: "BENIGN_to_BENIGN"

  - id: "CA12"
    base_id: "CA12"
    type: "INPUT_VAL"
    base_lines: [66]
    new_lines: [86]
    code: 'require(balanceOf[msg.sender] >= shares, "Insufficient balance");'
    base_security_function: "BENIGN"
    new_security_function: "BENIGN"
    transition: "BENIGN_to_BENIGN"

  - id: "CA13"
    base_id: "CA13"
    type: "STATE_MOD"
    base_lines: [72]
    new_lines: [93]
    code: "balanceOf[msg.sender] -= shares;"
    base_security_function: "BENIGN"
    new_security_function: "BENIGN"
    transition: "BENIGN_to_BENIGN"

  - id: "CA14"
    base_id: "CA14"
    type: "STATE_MOD"
    base_lines: [73]
    new_lines: [94]
    code: "totalSupply -= shares;"
    base_security_function: "BENIGN"
    new_security_function: "BENIGN"
    transition: "BENIGN_to_BENIGN"

  - id: "CA15"
    base_id: "CA15"
    type: "EXT_CALL"
    base_lines: [76]
    new_lines: [97]
    code: "_withdrawFromCurve(amount);"
    base_security_function: "BENIGN"
    new_security_function: "BENIGN"
    transition: "BENIGN_to_BENIGN"

  - id: "CA16"
    base_id: "CA16"
    type: "EVENT_EMIT"
    base_lines: [81]
    new_lines: [100]
    code: "emit Withdrawal(msg.sender, shares, amount);"
    base_security_function: "BENIGN"
    new_security_function: "BENIGN"
    transition: "BENIGN_to_BENIGN"

  - id: "CA19"
    base_id: "CA19"
    type: "STATE_MOD"
    base_lines: [107]
    new_lines: [149]
    code: "investedBalance += amount;"
    base_security_function: "BENIGN"
    new_security_function: "BENIGN"
    transition: "BENIGN_to_BENIGN"

  - id: "CA20"
    base_id: "CA20"
    type: "INPUT_VAL"
    base_lines: [120]
    new_lines: [156]
    code: 'require(investedBalance >= amount, "Insufficient invested");'
    base_security_function: "BENIGN"
    new_security_function: "BENIGN"
    transition: "BENIGN_to_BENIGN"

  - id: "CA21"
    base_id: "CA21"
    type: "STATE_MOD"
    base_lines: [121]
    new_lines: [157]
    code: "investedBalance -= amount;"
    base_security_function: "BENIGN"
    new_security_function: "BENIGN"
    transition: "BENIGN_to_BENIGN"

# ============================================
# UNRELATED CODE ACTS (batched)
# ============================================

unrelated_code_acts:

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    transition: "UNRELATED_to_UNRELATED"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: [4, 5, 6, 7, 8, 32, 35, 51, 52, 53, 54, 60, 71, 79, 80, 81, 82, 89, 96, 104, 105, 115, 116, 125, 126, 127, 136, 137, 138, 145, 146, 152, 153]
    security_function: "UNRELATED"
    transition: "UNRELATED_to_UNRELATED"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [10, 11, 12, 13, 14, 15, 16, 18, 19, 20, 21, 22, 23, 25, 26, 27, 29, 30, 33, 41, 42, 44, 45, 46, 56, 84, 129, 140, 148, 155]
    security_function: "UNRELATED"
    transition: "UNRELATED_to_UNRELATED"

  - id: "CA_SYNTAX"
    type: "SYNTAX"
    lines: [49, 66, 76, 77, 101, 102, 134, 143, 150, 158, 159]
    security_function: "UNRELATED"
    transition: "UNRELATED_to_UNRELATED"

summary:
  total_code_acts: 29  # 8 fix + 17 transitioned + 4 unrelated
  total_lines_covered: 141  # excludes empty lines

  by_transition:
    NEW_to_BENIGN: 8       # CA_FIX1 through CA_FIX8
    ROOT_CAUSE_to_BENIGN: 4   # CA1, CA2, CA3, CA4
    PREREQ_to_BENIGN: 2       # CA17, CA18
    BENIGN_to_BENIGN: 11      # CA5-CA16, CA19-CA21
    UNRELATED_to_UNRELATED: 4 # batched

  why_fix_works: "The _checkPriceDeviation() function compares the current spot price to a stored price that only updates after a minimum interval (1 hour). Flash loan attacks happen within a single transaction/block, so the attacker cannot update the stored price before manipulating the spot price. Any manipulation exceeding 5% deviation causes the transaction to revert."

  fix_elements:
    - "lastPricePerShare state variable (line 36)"
    - "lastPriceUpdate state variable (line 37)"
    - "MAX_PRICE_DEVIATION constant 5% (line 38)"
    - "MIN_PRICE_UPDATE_INTERVAL constant 1 hour (line 39)"
    - "_checkPriceDeviation() calls in deposit/withdraw (lines 58, 87)"
    - "_updatePrice() calls in deposit/withdraw (lines 73, 98)"
    - "_checkPriceDeviation() function implementation (lines 107-113)"
    - "_updatePrice() function implementation (lines 118-123)"

# ============================================
# LINE TO CODE ACT MAPPINGS (for scoring)
# ============================================

line_to_code_act:
  # Directives (UNRELATED)
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  # Line 3: empty
  # Comments (UNRELATED)
  4: "CA_COMMENTS"
  5: "CA_COMMENTS"
  6: "CA_COMMENTS"
  7: "CA_COMMENTS"
  8: "CA_COMMENTS"
  # Line 9: empty
  # Interface declarations (UNRELATED)
  10: "CA_DECLARATIONS"
  11: "CA_DECLARATIONS"
  12: "CA_DECLARATIONS"
  13: "CA_DECLARATIONS"
  14: "CA_DECLARATIONS"
  15: "CA_DECLARATIONS"
  16: "CA_DECLARATIONS"
  # Line 17: empty
  18: "CA_DECLARATIONS"
  19: "CA_DECLARATIONS"
  20: "CA_DECLARATIONS"
  21: "CA_DECLARATIONS"
  22: "CA_DECLARATIONS"
  23: "CA_DECLARATIONS"
  # Line 24: empty
  # Contract declarations (UNRELATED)
  25: "CA_DECLARATIONS"
  26: "CA_DECLARATIONS"
  27: "CA_DECLARATIONS"
  # Line 28: empty
  29: "CA_DECLARATIONS"
  30: "CA_DECLARATIONS"
  # Line 31: empty
  32: "CA_COMMENTS"
  33: "CA_DECLARATIONS"
  # Line 34: empty
  35: "CA_COMMENTS"
  # === FIX: Price deviation state variables ===
  36: "CA_FIX1"
  37: "CA_FIX1"
  38: "CA_FIX1"
  39: "CA_FIX1"
  # Line 40: empty
  # Event declarations
  41: "CA_DECLARATIONS"
  42: "CA_DECLARATIONS"
  # Line 43: empty
  # Constructor
  44: "CA_DECLARATIONS"
  45: "CA_DECLARATIONS"
  46: "CA_DECLARATIONS"
  # === FIX: Price initialization in constructor ===
  47: "CA_FIX2"
  48: "CA_FIX2"
  49: "CA_SYNTAX"
  # Line 50: empty
  # deposit() NatSpec
  51: "CA_COMMENTS"
  52: "CA_COMMENTS"
  53: "CA_COMMENTS"
  54: "CA_COMMENTS"
  # Line 55: empty
  56: "CA_DECLARATIONS"
  57: "CA5"
  # === FIX: Price deviation check in deposit ===
  58: "CA_FIX3"
  # Line 59: empty
  60: "CA_COMMENTS"
  61: "CA6"
  62: "CA6"
  63: "CA6"
  # === TRANSITIONED: Oracle call (ROOT_CAUSE → BENIGN) ===
  64: "CA1"
  65: "CA2"
  66: "CA_SYNTAX"
  # Line 67: empty
  68: "CA7"
  69: "CA8"
  # Line 70: empty
  71: "CA_COMMENTS"
  72: "CA9"
  # === FIX: Update price after deposit ===
  73: "CA_FIX4"
  # Line 74: empty
  75: "CA10"
  76: "CA_SYNTAX"
  77: "CA_SYNTAX"
  # Line 78: empty
  # withdraw() NatSpec
  79: "CA_COMMENTS"
  80: "CA_COMMENTS"
  81: "CA_COMMENTS"
  82: "CA_COMMENTS"
  # Line 83: empty
  84: "CA_DECLARATIONS"
  85: "CA11"
  86: "CA12"
  # === FIX: Price deviation check in withdraw ===
  87: "CA_FIX5"
  # Line 88: empty
  89: "CA_COMMENTS"
  # === TRANSITIONED: Oracle call (ROOT_CAUSE → BENIGN) ===
  90: "CA3"
  91: "CA4"
  # Line 92: empty
  93: "CA13"
  94: "CA14"
  # Line 95: empty
  96: "CA_COMMENTS"
  97: "CA15"
  # === FIX: Update price after withdraw ===
  98: "CA_FIX6"
  # Line 99: empty
  100: "CA16"
  101: "CA_SYNTAX"
  102: "CA_SYNTAX"
  # Line 103: empty
  # _checkPriceDeviation() NatSpec
  104: "CA_COMMENTS"
  105: "CA_COMMENTS"
  # Line 106: empty
  # === FIX: _checkPriceDeviation function ===
  107: "CA_FIX7"
  108: "CA_FIX7"
  109: "CA_FIX7"
  110: "CA_FIX7"
  111: "CA_FIX7"
  112: "CA_FIX7"
  113: "CA_FIX7"
  # Line 114: empty
  # _updatePrice() NatSpec
  115: "CA_COMMENTS"
  116: "CA_COMMENTS"
  # Line 117: empty
  # === FIX: _updatePrice function ===
  118: "CA_FIX8"
  119: "CA_FIX8"
  120: "CA_FIX8"
  121: "CA_FIX8"
  122: "CA_FIX8"
  123: "CA_FIX8"
  # Line 124: empty
  # getTotalAssets() NatSpec
  125: "CA_COMMENTS"
  126: "CA_COMMENTS"
  127: "CA_COMMENTS"
  # Line 128: empty
  129: "CA_DECLARATIONS"
  # === TRANSITIONED: getTotalAssets implementation (PREREQ → BENIGN) ===
  130: "CA17"
  131: "CA17"
  # Line 132: empty
  133: "CA17"
  134: "CA_SYNTAX"
  # Line 135: empty
  # getPricePerFullShare() NatSpec
  136: "CA_COMMENTS"
  137: "CA_COMMENTS"
  138: "CA_COMMENTS"
  # Line 139: empty
  140: "CA_DECLARATIONS"
  # === TRANSITIONED: getPricePerFullShare (PREREQ → BENIGN) ===
  141: "CA18"
  142: "CA18"
  143: "CA_SYNTAX"
  # Line 144: empty
  # _investInCurve() NatSpec
  145: "CA_COMMENTS"
  146: "CA_COMMENTS"
  # Line 147: empty
  148: "CA_DECLARATIONS"
  149: "CA19"
  150: "CA_SYNTAX"
  # Line 151: empty
  # _withdrawFromCurve() NatSpec
  152: "CA_COMMENTS"
  153: "CA_COMMENTS"
  # Line 154: empty
  155: "CA_DECLARATIONS"
  156: "CA20"
  157: "CA21"
  158: "CA_SYNTAX"
  159: "CA_SYNTAX"

code_act_security_functions:
  # Fix code acts (NEW)
  CA_FIX1: "BENIGN"
  CA_FIX2: "BENIGN"
  CA_FIX3: "BENIGN"
  CA_FIX4: "BENIGN"
  CA_FIX5: "BENIGN"
  CA_FIX6: "BENIGN"
  CA_FIX7: "BENIGN"
  CA_FIX8: "BENIGN"
  # Transitioned code acts (now BENIGN)
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "BENIGN"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA10: "BENIGN"
  CA11: "BENIGN"
  CA12: "BENIGN"
  CA13: "BENIGN"
  CA14: "BENIGN"
  CA15: "BENIGN"
  CA16: "BENIGN"
  CA17: "BENIGN"
  CA18: "BENIGN"
  CA19: "BENIGN"
  CA20: "BENIGN"
  CA21: "BENIGN"
  # Unrelated
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"
  CA_SYNTAX: "UNRELATED"
