schema_version: "1.0"
sample_id: "df_tc_014"
base_sample_id: "ms_tc_014"
vulnerability_type: "price_oracle_manipulation"
is_fixed: true

fix_summary:
  description: "Implemented TWAP (Time-Weighted Average Price) instead of spot price."
  fix_type: "oracle_hardening"
  vulnerable_pattern: "Uses spot virtual price from Curve"
  fixed_pattern: "Uses TWAP calculated over time"

vulnerable_version:
  reference: "../minimalsanitized/code_acts_annotation/ms_tc_014.yaml"
  # vulnerable_lines (reference only): [75, 109]
  root_cause_description: "get_virtual_price() is manipulable within a transaction"

fixed_version:
  fix_lines: [48, 49, 80, 81, 82, 83, 84, 85, 108]
  fix_description: "Added twapPrice (line 48) and lastUpdateTime (line 49). earn() calculates TWAP (lines 80-85). balance() uses twapPrice (line 108)."

code_acts:

  - id: "CA_FIX1"
    type: "DECLARATION"
    lines: [48, 49]
    code: |
      uint256 public twapPrice;
      uint256 public lastUpdateTime;
    security_function: "FIX"
    rationale: "FIX - TWAP state variables to track time-weighted price."

  - id: "CA_FIX2"
    type: "COMPUTATION"
    lines: [80, 81, 82, 83, 84, 85]
    code: |
      uint256 spotPrice = curve3Pool.get_virtual_price();
      uint256 timeElapsed = block.timestamp - lastUpdateTime;
      if (timeElapsed > 0) {
          twapPrice = (twapPrice * lastUpdateTime + spotPrice * timeElapsed) / block.timestamp;
          lastUpdateTime = block.timestamp;
      }
    security_function: "FIX"
    rationale: "FIX - TWAP calculation smooths price over time, preventing flash loan manipulation."

  - id: "CA_FIX3"
    type: "COMPUTATION"
    lines: [105, 106, 107, 108, 109]
    code: |
      function balance() public view returns (uint256) {
          return
              dai.balanceOf(address(this)) +
              (crv3.balanceOf(address(this)) * twapPrice) / 1e18;
      }
    security_function: "FIX"
    rationale: "FIX - Uses twapPrice instead of spot price for valuation."

  - id: "CA1"
    type: "DECLARATION"
    lines: [42, 43, 44]
    code: |
      mapping(address => uint256) public shares;
      uint256 public totalShares;
      uint256 public totalDeposits;
    security_function: "BENIGN"
    rationale: "Share tracking declarations."

  - id: "CA2"
    type: "EXT_CALL"
    lines: [59]
    code: "dai.transferFrom(msg.sender, address(this), amount);"
    security_function: "BENIGN"
    rationale: "DAI deposit transfer."

  - id: "CA3"
    type: "COMPUTATION"
    lines: [61, 62, 63, 64, 65, 66]
    code: |
      uint256 shareAmount;
      if (totalShares == 0) {
          shareAmount = amount;
      } else {
          shareAmount = (amount * totalShares) / totalDeposits;
      }
    security_function: "BENIGN"
    rationale: "Share calculation."

  - id: "CA4"
    type: "STATE_MOD"
    lines: [68, 69, 70]
    code: |
      shares[msg.sender] += shareAmount;
      totalShares += shareAmount;
      totalDeposits += amount;
    security_function: "BENIGN"
    rationale: "Deposit state updates."

  - id: "CA5"
    type: "EXT_CALL"
    lines: [87, 88, 89]
    code: |
      dai.approve(address(curve3Pool), vaultBalance);
      uint256[3] memory amounts = [vaultBalance, 0, 0];
      curve3Pool.add_liquidity(amounts, 0);
    security_function: "BENIGN"
    rationale: "Curve liquidity addition."

  - id: "CA_DIRECTIVES"
    type: "DIRECTIVE"
    lines: [1, 2]
    security_function: "UNRELATED"
    rationale: "License and pragma statements"

  - id: "CA_COMMENTS"
    type: "COMMENT"
    lines: [4, 5, 6, 7]
    security_function: "UNRELATED"
    rationale: "NatSpec documentation"

  - id: "CA_DECLARATIONS"
    type: "DECLARATION"
    lines: [9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 37, 38, 39, 40, 46, 51, 52, 53, 54, 55, 56, 58, 73, 74, 75, 76, 77, 78, 92, 93, 94, 96, 98, 99, 100, 102, 103, 110]
    security_function: "UNRELATED"
    rationale: "Interface, contract, and function signature declarations"

  - id: "CA_SYNTAX"
    type: "SYNTAX"
    lines: [22, 36, 71, 90]
    security_function: "UNRELATED"
    rationale: "Closing braces"

summary:
  total_code_acts: 13

  fix_applied:
    type: "oracle_hardening"
    description: "TWAP instead of spot price"
    lines_changed: [48, 49, 80, 81, 82, 83, 84, 85, 108]

  by_security_function_fixed:
    FIX: 3
    BENIGN: 5
    UNRELATED: 4

line_to_code_act_fixed:
  1: "CA_DIRECTIVES"
  2: "CA_DIRECTIVES"
  4: "CA_COMMENTS"
  5: "CA_COMMENTS"
  6: "CA_COMMENTS"
  7: "CA_COMMENTS"
  9: "CA_DECLARATIONS"
  10: "CA_DECLARATIONS"
  11: "CA_DECLARATIONS"
  12: "CA_DECLARATIONS"
  13: "CA_DECLARATIONS"
  # Line 14: empty
  15: "CA_DECLARATIONS"
  16: "CA_DECLARATIONS"
  17: "CA_DECLARATIONS"
  18: "CA_DECLARATIONS"
  # Line 19: empty
  20: "CA_DECLARATIONS"
  21: "CA_DECLARATIONS"
  # Line 22: empty
  23: "CA_DECLARATIONS"
  24: "CA_DECLARATIONS"
  # Line 25: empty
  26: "CA_DECLARATIONS"
  27: "CA_DECLARATIONS"
  28: "CA_DECLARATIONS"
  29: "CA_DECLARATIONS"
  30: "CA_DECLARATIONS"
  # Line 31: empty
  32: "CA_DECLARATIONS"
  # Line 33: empty
  34: "CA_DECLARATIONS"
  35: "CA_DECLARATIONS"
  # Line 36: empty
  37: "CA_DECLARATIONS"
  38: "CA_DECLARATIONS"
  39: "CA_DECLARATIONS"
  40: "CA_DECLARATIONS"
  42: "CA1"
  43: "CA1"
  44: "CA1"
  46: "CA_DECLARATIONS"
  48: "CA_FIX1"
  49: "CA_FIX1"
  51: "CA_DECLARATIONS"
  52: "CA_DECLARATIONS"
  53: "CA_DECLARATIONS"
  54: "CA_DECLARATIONS"
  55: "CA_DECLARATIONS"
  56: "CA_DECLARATIONS"
  58: "CA_DECLARATIONS"
  59: "CA2"
  61: "CA3"
  62: "CA3"
  63: "CA3"
  64: "CA3"
  65: "CA3"
  66: "CA3"
  68: "CA4"
  69: "CA4"
  70: "CA4"
  71: "CA_SYNTAX"
  73: "CA_DECLARATIONS"
  74: "CA_DECLARATIONS"
  75: "CA_DECLARATIONS"
  76: "CA_DECLARATIONS"
  77: "CA_DECLARATIONS"
  78: "CA_DECLARATIONS"
  80: "CA_FIX2"
  81: "CA_FIX2"
  82: "CA_FIX2"
  83: "CA_FIX2"
  84: "CA_FIX2"
  85: "CA_FIX2"
  87: "CA5"
  88: "CA5"
  89: "CA5"
  90: "CA_SYNTAX"
  92: "CA_DECLARATIONS"
  93: "CA_DECLARATIONS"
  94: "CA_DECLARATIONS"
  96: "CA_DECLARATIONS"
  98: "CA_DECLARATIONS"
  99: "CA_DECLARATIONS"
  100: "CA_DECLARATIONS"
  102: "CA_DECLARATIONS"
  103: "CA_DECLARATIONS"
  105: "CA_FIX3"
  106: "CA_FIX3"
  107: "CA_FIX3"
  108: "CA_FIX3"
  109: "CA_FIX3"
  110: "CA_DECLARATIONS"

code_act_security_functions_fixed:
  CA_FIX1: "FIX"
  CA_FIX2: "FIX"
  CA_FIX3: "FIX"
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA_DIRECTIVES: "UNRELATED"
  CA_COMMENTS: "UNRELATED"
  CA_DECLARATIONS: "UNRELATED"
  CA_SYNTAX: "UNRELATED"
