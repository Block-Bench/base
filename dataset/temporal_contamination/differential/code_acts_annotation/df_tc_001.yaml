schema_version: "1.0"
sample_id: "df_tc_001"
base_sample_id: "ms_tc_001"
vulnerability_type: "improper_initialization"
is_vulnerable: false

# Differential annotation tracks Security Function transitions from vulnerable to fixed version.
# This file documents how ROOT_CAUSE elements became BENIGN after the fix.

vulnerability_summary:
  type: "improper_initialization"
  severity: "critical"
  affected_functions: ["process", "constructor", "setAcceptedRoot"]
  root_cause_summary: "acceptedRoot declared without initialization, defaulting to bytes32(0)"
  fix_summary: "Constructor now initializes acceptedRoot to non-zero value; setAcceptedRoot requires non-zero input"

code_acts:

  # ============================================
  # TRANSITIONED CODE ACTS (ROOT_CAUSE -> BENIGN)
  # ============================================

  - id: "CA1"
    type: "DECLARATION"
    description: "acceptedRoot state variable declaration"

    vulnerable:
      file: "ms_tc_001.sol"
      function: "contract"
      line: 18
      code: "bytes32 public acceptedRoot;"
      security_function: "ROOT_CAUSE"
      rationale: "Declared without initialization, defaults to bytes32(0)"

    fixed:
      file: "df_tc_001.sol"
      function: "contract"
      line: 18
      code: "bytes32 public acceptedRoot;"
      security_function: "BENIGN"
      rationale: "Same declaration, but now properly initialized in constructor at line 27"

    transition: "ROOT_CAUSE -> BENIGN"
    transition_reason: "Declaration itself unchanged, but constructor now initializes the variable"

  - id: "CA2"
    type: "INITIALIZATION"
    description: "Constructor initialization"

    vulnerable:
      file: "ms_tc_001.sol"
      function: "constructor"
      lines: [28, 29, 30]
      code: |
        constructor(address _bridgeRouter) {
            bridgeRouter = _bridgeRouter;
        }
      security_function: "ROOT_CAUSE"
      rationale: "Constructor omits initialization of acceptedRoot"

    fixed:
      file: "df_tc_001.sol"
      function: "constructor"
      lines: [25, 26, 27, 28]
      code: |
        constructor(address _bridgeRouter) {
            bridgeRouter = _bridgeRouter;
            acceptedRoot = keccak256("initial_root");
        }
      security_function: "BENIGN"
      rationale: "Constructor now initializes acceptedRoot to a non-zero hash value"

    transition: "ROOT_CAUSE -> BENIGN"
    transition_reason: "Added acceptedRoot = keccak256('initial_root') initialization"

  - id: "CA6"
    type: "INPUT_VAL"
    description: "Root validation check"

    vulnerable:
      file: "ms_tc_001.sol"
      function: "process"
      line: 53
      code: 'require(root == acceptedRoot, "Invalid root");'
      security_function: "ROOT_CAUSE"
      rationale: "Check passes when both root and acceptedRoot are zero (0x00 == 0x00)"

    fixed:
      file: "df_tc_001.sol"
      function: "process"
      line: 44
      code: 'require(root == acceptedRoot, "Invalid root");'
      security_function: "BENIGN"
      rationale: "Check now works correctly because acceptedRoot is non-zero"

    transition: "ROOT_CAUSE -> BENIGN"
    transition_reason: "Same check, but now acceptedRoot is initialized to non-zero value"

  # ============================================
  # TRANSITIONED CODE ACTS (SECONDARY_VULN -> BENIGN)
  # ============================================

  - id: "CA13"
    type: "ACCESS_CTRL"
    description: "setAcceptedRoot function"

    vulnerable:
      file: "ms_tc_001.sol"
      function: "setAcceptedRoot"
      lines: [83, 84, 85]
      code: |
        function setAcceptedRoot(bytes32 _newRoot) external {
            acceptedRoot = _newRoot;
        }
      security_function: "SECONDARY_VULN"
      rationale: "Missing access control AND allows zero root. Secondary vulnerability not related to documented exploit."

    fixed:
      file: "df_tc_001.sol"
      function: "setAcceptedRoot"
      lines: [71, 72, 73, 74]
      code: |
        function setAcceptedRoot(bytes32 _newRoot) external {
            require(_newRoot != bytes32(0), "Root cannot be zero");
            acceptedRoot = _newRoot;
        }
      security_function: "SECONDARY_VULN"
      rationale: "Added zero check (line 72), but still missing access control (onlyOwner). Partial fix only."

    transition: "SECONDARY_VULN -> SECONDARY_VULN"
    transition_reason: "Zero check added, but missing access control remains a vulnerability"

  # ============================================
  # UNCHANGED CODE ACTS (BENIGN -> BENIGN)
  # ============================================

  - id: "CA3"
    type: "COMPUTATION"
    description: "Message hash computation"

    vulnerable:
      file: "ms_tc_001.sol"
      function: "process"
      line: 42
      code: "bytes32 messageHash = keccak256(_message);"
      security_function: "BENIGN"
      rationale: "Correct hash computation"

    fixed:
      file: "df_tc_001.sol"
      function: "process"
      line: 36
      code: "bytes32 messageHash = keccak256(_message);"
      security_function: "BENIGN"
      rationale: "Unchanged, still correct"

    transition: "BENIGN -> BENIGN"

  - id: "CA4"
    type: "INPUT_VAL"
    description: "Replay protection check"

    vulnerable:
      file: "ms_tc_001.sol"
      function: "process"
      lines: [45, 46, 47, 48]
      code: |
        require(
            messages[messageHash] != MessageStatus.Processed,
            "Already processed"
        );
      security_function: "BENIGN"
      rationale: "Correct replay protection"

    fixed:
      file: "df_tc_001.sol"
      function: "process"
      lines: [38, 39, 40, 41]
      code: |
        require(
            messages[messageHash] != MessageStatus.Processed,
            "Already processed"
        );
      security_function: "BENIGN"
      rationale: "Unchanged, still correct"

    transition: "BENIGN -> BENIGN"

  - id: "CA7"
    type: "STATE_MOD"
    description: "Mark message as processed"

    vulnerable:
      file: "ms_tc_001.sol"
      function: "process"
      line: 56
      code: "messages[messageHash] = MessageStatus.Processed;"
      security_function: "BENIGN"
      rationale: "Correct CEI pattern - state update before external call"

    fixed:
      file: "df_tc_001.sol"
      function: "process"
      line: 46
      code: "messages[messageHash] = MessageStatus.Processed;"
      security_function: "BENIGN"
      rationale: "Unchanged, still correct CEI pattern"

    transition: "BENIGN -> BENIGN"

  - id: "CA8"
    type: "EXT_CALL"
    description: "Bridge router external call"

    vulnerable:
      file: "ms_tc_001.sol"
      function: "process"
      line: 59
      code: "(bool routerSuccess, ) = bridgeRouter.call(_message);"
      security_function: "PREREQ"
      rationale: "External call that transfers funds - prerequisite for financial impact"

    fixed:
      file: "df_tc_001.sol"
      function: "process"
      line: 48
      code: "(bool routerSuccess, ) = bridgeRouter.call(_message);"
      security_function: "BENIGN"
      rationale: "With proper root validation, this call is no longer exploitable"

    transition: "PREREQ -> BENIGN"
    transition_reason: "No longer a prerequisite since the vulnerability is fixed"

  - id: "CA9"
    type: "EVENT_EMIT"
    description: "MessageProcessed event emission"

    vulnerable:
      file: "ms_tc_001.sol"
      function: "process"
      line: 61
      code: "emit MessageProcessed(messageHash, routerSuccess);"
      security_function: "BENIGN"
      rationale: "Logging only"

    fixed:
      file: "df_tc_001.sol"
      function: "process"
      line: 50
      code: "emit MessageProcessed(messageHash, routerSuccess);"
      security_function: "BENIGN"
      rationale: "Unchanged"

    transition: "BENIGN -> BENIGN"

  - id: "CA10"
    type: "CTRL_FLOW"
    description: "Return statement"

    vulnerable:
      file: "ms_tc_001.sol"
      function: "process"
      line: 62
      code: "return routerSuccess;"
      security_function: "BENIGN"
      rationale: "Return value propagation"

    fixed:
      file: "df_tc_001.sol"
      function: "process"
      line: 51
      code: "return routerSuccess;"
      security_function: "BENIGN"
      rationale: "Unchanged"

    transition: "BENIGN -> BENIGN"

  # ============================================
  # TRANSITIONED CODE ACTS (PREREQ -> BENIGN)
  # ============================================

  - id: "CA5"
    type: "CTRL_FLOW"
    description: "Root computation call"

    vulnerable:
      file: "ms_tc_001.sol"
      function: "process"
      line: 52
      code: "bytes32 root = _messageRoot(_message);"
      security_function: "PREREQ"
      rationale: "Calls _messageRoot which can return bytes32(0)"

    fixed:
      file: "df_tc_001.sol"
      function: "process"
      line: 43
      code: "bytes32 root = _messageRoot(_message);"
      security_function: "BENIGN"
      rationale: "Still returns bytes32(0) for crafted messages, but acceptedRoot is non-zero so exploit fails"

    transition: "PREREQ -> BENIGN"
    transition_reason: "No longer enables exploit since acceptedRoot is properly initialized"

  - id: "CA11"
    type: "CTRL_FLOW"
    description: "Zero root return condition in _messageRoot"

    vulnerable:
      file: "ms_tc_001.sol"
      function: "_messageRoot"
      lines: [76, 77, 78]
      code: |
        if (_message.length > 32 && uint256(bytes32(_message)) == 0) {
            return bytes32(0);
        }
      security_function: "PREREQ"
      rationale: "Returns bytes32(0) for crafted messages - enables matching uninitialized acceptedRoot"

    fixed:
      file: "df_tc_001.sol"
      function: "_messageRoot"
      lines: [61, 62, 63]
      code: |
        if (_message.length > 32 && uint256(bytes32(_message)) == 0) {
            return bytes32(0);
        }
      security_function: "BENIGN"
      rationale: "Still returns bytes32(0), but cannot match initialized acceptedRoot"

    transition: "PREREQ -> BENIGN"
    transition_reason: "Returning bytes32(0) no longer enables exploit"

  - id: "CA12"
    type: "CTRL_FLOW"
    description: "Default keccak256 return in _messageRoot"

    vulnerable:
      file: "ms_tc_001.sol"
      function: "_messageRoot"
      line: 80
      code: "return keccak256(_message);"
      security_function: "BENIGN"
      rationale: "Correct hash computation"

    fixed:
      file: "df_tc_001.sol"
      function: "_messageRoot"
      line: 65
      code: "return keccak256(_message);"
      security_function: "BENIGN"
      rationale: "Unchanged"

    transition: "BENIGN -> BENIGN"

summary:
  total_code_acts: 13

  transitions:
    ROOT_CAUSE_to_BENIGN: 3  # CA1, CA2, CA6
    SECONDARY_VULN_to_SECONDARY_VULN: 1  # CA13 (partial fix)
    PREREQ_to_BENIGN: 3  # CA5, CA8, CA11
    BENIGN_to_BENIGN: 6  # CA3, CA4, CA7, CA9, CA10, CA12

  by_security_function_vulnerable:
    ROOT_CAUSE: 3
    SECONDARY_VULN: 1
    PREREQ: 3
    BENIGN: 6

  by_security_function_fixed:
    SECONDARY_VULN: 1  # CA13 still vulnerable (missing access control)
    BENIGN: 12  # CA1-CA12 all become BENIGN

  fix_effectiveness:
    documented_vuln_fixed: true
    secondary_vuln_fixed: false
    notes: "Primary vulnerability (improper_initialization) is fixed. Secondary vulnerability (missing access control on setAcceptedRoot) remains partially unfixed."

  root_cause_fixes:
    - id: "CA1"
      fix_type: "initialization_added"
      description: "acceptedRoot now initialized in constructor"
    - id: "CA2"
      fix_type: "initialization_added"
      description: "Constructor explicitly sets acceptedRoot = keccak256('initial_root')"
    - id: "CA6"
      fix_type: "semantic_fix"
      description: "Validation check now works correctly due to non-zero acceptedRoot"

# ============================================
# LINE TO CODE ACT MAPPINGS (for scoring)
# ============================================
# Maps line numbers to code acts for the fixed version.
# Scoring: lookup line → code_act → security_function
#
# NOTE: Differential annotations only map security-relevant code acts.
# UNRELATED items (comments, directives, syntax) are not tracked because:
# 1. They don't transition - remain UNRELATED in both versions
# 2. Differential evaluates fix recognition, not hallucination detection
# 3. Full coverage is handled by minimalsanitized annotations

line_to_code_act_fixed:
  # Security-relevant code acts in df_tc_001.sol
  18: "CA1"      # acceptedRoot declaration
  25: "CA2"      # constructor
  26: "CA2"
  27: "CA2"
  28: "CA2"
  36: "CA3"      # messageHash computation
  38: "CA4"      # replay protection
  39: "CA4"
  40: "CA4"
  41: "CA4"
  43: "CA5"      # root computation call
  44: "CA6"      # root validation
  46: "CA7"      # mark processed
  48: "CA8"      # external call
  50: "CA9"      # event emission
  51: "CA10"     # return
  61: "CA11"     # zero root conditional
  62: "CA11"
  63: "CA11"
  65: "CA12"     # default keccak return
  71: "CA13"     # setAcceptedRoot
  72: "CA13"
  73: "CA13"
  74: "CA13"

code_act_security_functions_fixed:
  CA1: "BENIGN"
  CA2: "BENIGN"
  CA3: "BENIGN"
  CA4: "BENIGN"
  CA5: "BENIGN"
  CA6: "BENIGN"
  CA7: "BENIGN"
  CA8: "BENIGN"
  CA9: "BENIGN"
  CA10: "BENIGN"
  CA11: "BENIGN"
  CA12: "BENIGN"
  CA13: "SECONDARY_VULN"  # still missing access control
